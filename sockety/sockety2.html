<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPK Częstochowa</title>
    <link rel="stylesheet" href="sockety-style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<body>
    <div id="black-viniette"></div>

    <button id="fetchSid">Pobierz SID</button>
    <button onclick="renewSid()">Ping SID</button>
    <button id="sendRequest">Wyślij żądanie 1 vehicles</button>
    <button id="sendRequest2">Wyślij żądanie 2 vehicles numery</button>
    <button id="sendRequest3">Wyślij żądanie 3 Puste</button>

    <button onclick="gsid()">gsid()</button>

    <input type="text" id="input">
    <button onclick="send()">Wyślij</button><br>

    <!--button onclick="wshandshake('exec', '')">WS handshake</button-->
    <button onclick="handshakeSelector('exec')">WS handshake</button>
    <button onclick="handshakeSelector('gps')">WS handshake GPS</button>
    <button onclick="loadVehicleMap()">LoadVehicleMap</button>
    <button onclick="processVData()">processVData()</button>
    <button onclick="gpsTester()">gpsTester()</button>
    <button onclick="test3()">test3()</button>
    <br><br>

    <button onclick="sendRequest(`15:40/vehicle_gps,`);">vehicle gps</button>
    <button onclick='sendRequest(`67:42/vehicle_gps,["vehicleID","e6c0a250-f18e-470f-b1cf-eda724cf1ea3"]`);'>gps dane</button>
    <button onclick='sendRequest(`67:42/vehicle_gps,["vehicleID","daaad901-94e8-4950-92a7-b0a46dc77677"]`);'>gps dane2</button>

    <br><br>

    <button onclick="loadWozy()">Załaduj wozy</button>
    Ważność SID <span id="waznosc-sid-span">0</span>s
    <div id="suma-select-dsp"></div>
    <div id="wozy-data-kontener">
        <div id="marki-kontener"></div>
        <div id="wozy-right-kontener">
            <div id="data-wozy-dsp"></div>
            <div id="wozy-selected-kontener"></div>
        </div>
    </div>

    <br>
    <button onclick="createRequest()" id="check-vehicles-button">Sprawdź wozy</button>

    <h2 style="clear: both;">Sprawdzanie wozów:</h2><br>
    <button onclick="autoQ('porecz')">Wszystkie poręczaki</button><br>
    <button onclick="autoQ('105')">Wszystkie 105Na</button><br>
    <button onclick="autoQ('krakus')">Wszystkie krakusy</button><br>
    <button onclick="autoQ('218')">218</button><br>
    <button onclick="autoQ('219')">219</button><br>
    <button onclick="autoQ('128')">128</button><br>

    <br><br>
    <div id="map" style="display: none;">
        <div id="tracking-vmax"></div>
        <div id="tracking-info"></div>
    </div>
    <br><br>

    <button onclick="openConsole()">Konsoleta</button>
    <button onclick="switchMap()">Mapa</button>

    <br><br>

    <div id="konsola-obszar" style="display: none;">
        <div id="konsola-pole"></div>
        <div id="konsola-input-kontener">
            <span id="konsola-symbol">&gt;</span>
            <input type="text" id="input-console">
        </div>
    </div>


    <div id="live-data-dsp"></div>
    <div id="data-dsp"></div>

    <div id="alert-box">
        <div id="alert-box-header">
            <span id="alert-wariant"></span>
            <div id="alert-title"></div> <!-- Pomysły na alerta. Może kropke koloru jak w apple, i kolor tekst -->
            <button id="alert-close-button" onclick="closeAlertF()">[X]</button>
        </div>
        <div id="alert-content"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-hotline@0.4.0/dist/leaflet.hotline.min.js"></script>
    <script>
        /*/-----  D E V   T O O L S  -----/*/


        //Network filter:
        //tile.openstreetmap.org kaspersky
        //tile.openstreetmap.org kaspersky leaflet

        //Console filter:
        //-violation

        /*/-----  M A P A  -----/*/

        var mapOptions = {
            center: [50.8116,19.1148],
            zoom: 13, //13
            maxZoom: 19
        }

        var map = new L.map('map', mapOptions);

        var googleHybrid = new L.tileLayer('https://{s}.google.com/vt?lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 22,
            subdomains: ['mt0','mt1','mt2','mt3']
        });
        var googleSatelite = new L.tileLayer('https://{s}.google.com/vt?lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 22,
            subdomains: ['mt0','mt1','mt2','mt3']
        });
        var osm = new L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxNativeZoom: 19, // OSM max available zoom is at 19.
            maxZoom: 22, // Match the map maxZoom, or leave map.options.maxZoom undefined.
            opacity: 0.7

        });

        map.addLayer(osm);

        var vehiclesMapObject = {};
        var markers = [];

        function cleanMapMarkers(){
            markers.forEach(markerItem => {
                markerItem.remove();
            });
            markers = [];
        }

        //vehiclesMapObject[lp.taborNo] = [lp.latitude, lp.longitude, lp.lineNo, lp.direction, lp.dateTime, actDriver];

        //#FFD700

        L.marker([50.786739349365234, 19.132789611816406]).addTo(map).bindPopup(`
            <div class="popup-div">
                <span style="color: red; font-weight: 600;">Pojazd: 680</span> &nbsp;&nbsp;&nbsp; 
                <span style="color: blue;">Linia: <span style="font-weight: 600;">2</span> </span><br>
                <span style="color: #e67e22;">Kierunek: Fieldorfa Nila ZAJEZDNIA TRAMW</span><br> 
                <span style="color: green;">26.01.2025, 23:06:14</span><br> 
                <span style="color: #852a2a;">Prędkość: [km/h]</span><br><br>
                <div style="text-align: right;">
                    <button onclick="refreshVehicle(680);" class="button-odswiez">Odśwież</button>
                </div>
            </div>
        `);


        // Tworzymy nowy div z napisem
        const labelDiv = L.DomUtil.create('div', 'custom-label');
        labelDiv.innerHTML = "Mój napis w rogu mapy";
        labelDiv.style.position = 'absolute';
        labelDiv.style.bottom = '10px';
        labelDiv.style.right = '10px';
        labelDiv.style.background = 'rgba(255,255,255,0.8)';
        labelDiv.style.padding = '5px';
        labelDiv.style.borderRadius = '5px';

        // Dodajemy do mapy
        map.getContainer().appendChild(labelDiv);



        function driverTooltip(imgElement, text){
            var driverInfo = imgElement.closest('.popup-div').querySelector('.driver-info');

            // Sprawdź aktualną widoczność tooltipa
            if (driverInfo.style.display === 'none' || driverInfo.style.display === '') {
                driverInfo.innerHTML = `<hr>Kierowca: ${text}<hr>`;
                driverInfo.style.display = 'block';
            } else {
                driverInfo.style.display = 'none';
            }
        }

        /*var popupTemplate = `
            <div class="popup-div">
                <span style="color: red; font-weight: 600;">Pojazd: ${vehicleItem}</span> &nbsp;&nbsp;&nbsp; 
                <span style="color: blue;">Linia: <span style="font-weight: 600;">${lineNo}</span> </span><br>
                <span style="color: #e67e22;">Kierunek: ${direction}</span><br> 
                <span style="color: green;">${convertTime(dateTime).dateTime}</span><br> 
                <span style="color: #852a2a;">Prędkość: [km/h]</span><br>
                <div class="driver-info"></div>
                <div class="driver-icon-roz">
                    <div class="d-icon-box">
                        ${imgToDsp}
                    </div>
                    <div class='d-prowadnica-b'>
                        <button onclick="refreshVehicle(${vehicleItem}, ${markers.length});" class="button-odswiez">Odśwież</button>
                    </div>
                </div>
            </div>
        `;*/

        //popupTemplate(vehicleItem, lineNo, direction, convertTime(dateTime).dateTime, 0, imgToDsp, markers.length);

        function popupTemplate(taborNo, lineNo, direction, dateTime, velocity = "", markersLen){
            var imageIcon = imgObject[taborNo] || "";
            return `
                <div class="popup-div">
                    <span style="color: red; font-weight: 600;">Pojazd: ${taborNo}</span> &nbsp;&nbsp;&nbsp; 
                    <span style="color: blue;">Linia: <span style="font-weight: 600;">${lineNo}</span> </span><br>
                    <span style="color: #e67e22;">Kierunek: ${direction}</span><br> 
                    <span style="color: green;">${dateTime}</span><br> 
                    <span style="color: #852a2a;">Prędkość: ${velocity} [km/h]</span><br>
                    <div class="driver-info"></div>
                    <div class="driver-icon-roz">
                        <div class="d-icon-box">
                            ${imageIcon}
                        </div>
                        <div class='d-prowadnica-b'>
                            <button onclick="refreshVehicle(${taborNo}, ${markersLen});" class="button-odswiez">Odśwież</button>
                        </div>
                    </div>
                </div>
            `;
        }

        var imgObject = {};
        var rideLine;

        function loadVehicleMap(){
            cleanMapMarkers()
            for (var vehicleItem in vehiclesMapObject){
                if (vehiclesMapObject.hasOwnProperty(vehicleItem)){
                    var vehicleData = vehiclesMapObject[vehicleItem];
                    console.log(vehicleData);

                    var latitude = vehicleData[0];
                    var longitude = vehicleData[1];
                    var lineNo = vehicleData[2];
                    var direction = vehicleData[3];
                    var dateTime = vehicleData[4];
                    var driver = vehicleData[5];

                    /*var markerAdd = L.marker([latitude, longitude]).addTo(map).bindPopup(`
                        <span style="color: red;">Pojazd: ${vehicleItem}</span> &nbsp;&nbsp;&nbsp; 
                        <span style="color: blue;">Linia: ${lineNo} </span><br> 
                        <span style="color: #FFD700;">Kierunek: <br> ${direction}</span><br> 
                        <span style="color: green;">${convertTime(dateTime).dateTime}</span><br> 
                        Prędkość  [km/h]<br><br>
                        <a style="float: right; color: blue;">Odśwież</a>
                    `);*/

                    var imgToDsp = "";

                    if (driver != undefined){
                        var driverText = [
                            driver.imie && driver.nazwisko ? driver.imie + " " + driver.nazwisko : driver.imie || driver.nazwisko, 
                            driver.nick
                        ].filter(Boolean).join(", ");

                        imgToDsp = `<img src="images/icon_good.png" class="d-icon" title="Zidentyfikowany kierowca" onclick="driverTooltip(this, '${driverText}')">`;
                        imgObject[vehicleItem] = imgToDsp;
                    }

                    var markerAdd = L.marker([latitude, longitude]).addTo(map)
                        .bindPopup(popupTemplate(vehicleItem, lineNo, direction, convertTime(dateTime).dateTime, "", markers.length));
                    markers.push(markerAdd);
                    
                }
            }
        }

        var mapa = document.getElementById('map');

        function switchMap(){
            if (mapa.style.display == "none"){
                mapa.style.display = "block";
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            }else{
                mapa.style.display = "none";
            }
        }

        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // Promień Ziemi w km
            const dLat = toRadians(lat2 - lat1);
            const dLon = toRadians(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 +
                    Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                    Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Dystans w km
        }

        function calculateSpeed(lat1, lon1, lat2, lon2, timeInSeconds) {
            const distance = haversine(lat1, lon1, lat2, lon2); // Odległość w km
            const timeInHours = timeInSeconds / 3600; // Konwersja czasu na godziny
            return distance / timeInHours; // Prędkość w km/h
        }

        /*function getColorForSpeed(speed) {
            // Mapowanie prędkości na kolor
            if (speed <= 0) return "yellow"; // 0 km/h → Żółty
            if (speed >= 80) return "red";    // 80 km/h → Czerwony

            // Przejście kolorystyczne (żółty → czerwony)
            var r = 255; // Czerwony zawsze 255
            var g = Math.floor(255 * (1 - speed / 80)); // Zielony maleje od 255 (żółty) do 0 (czerwony)

            return `rgb(${r}, ${g}, 0)`;
        }*/


        function getColorForSpeed(speed) {
            if (speed <= 0) return "rgb(70, 255, 0)"; // 0 km/h → Zielony z lekkim odcieniem niebieskiego
            if (speed >= 80) return "red";  // 80 km/h → Czerwony

            let r, g, b;
            let ratio = speed / 80; // Normalizacja do zakresu 0-1

            if (ratio < 0.3) {
                // Zielony → Żółty (0 - 24 km/h)
                r = Math.floor(255 * (ratio / 0.3));
                g = 255;
                b = 0;
            } else {
                // Żółty → Czerwony (24 - 80 km/h)
                r = 255;
                g = Math.floor(255 * (1 - (ratio - 0.3) / 0.7));
                b = 0;
            }

            return `rgb(${r}, ${g}, ${b})`;
        }






        //Zapamiętywanie ikon
        //Pętla inna karta
        //Schematy kolorystyczne lini




        var oneVehicleTab = [];
        var trackingState = false; //Zmienić na true w razie potrzeby

        //SETTINGS
        var travelTime = 10;

        var rideLineArray = [];
        var lastLatLng;
        var lastVelocity;
        var polylineArray = [];

        var vMax = 0;

        function updateVehiclePopup(idVehicle, markerPole, dataObj){
            var image = imgObject[idVehicle];
            console.log(image);

            tenMarker = markers[markerPole];

            var odczyt0 = dataObj[1][0];
            var odczyt1 = dataObj[1][1];
            console.log(odczyt0);

            var velocity = calculateSpeed(odczyt1.latitude, odczyt1.longitude, odczyt0.latitude, odczyt0.longitude, travelTime);
            velocity = Math.round(velocity);
            console.log(velocity);

            var latLng = [odczyt0.latitude, odczyt0.longitude];

            tenMarker.setLatLng(latLng); 
            tenMarker.getPopup() //Problem z img
                .setContent(popupTemplate(odczyt0.taborNo, odczyt0.lineNo, odczyt0.direction, convertTime(odczyt0.dateTime).dateTime, velocity, markerPole));


            /*tenMarker.getPopup().update({
                content: popupTemplate(odczyt0.taborNo, odczyt0.lineNo, odczyt0.direction, convertTime(odczyt0.dateTime).dateTime, velocity, markerPole)
            });*/



               
            /*if (!rideLineArray.includes(latLng)){
                L.marker(latLng).addTo(map)
                rideLine.addLatLng(latLng);

                rideLineArray.push(latLng);
            }*/
            if (trackingState == true){
                if ((lastLatLng && lastLatLng.length != 0) && lastLatLng != latLng && (velocity > 0 || lastVelocity > 0)){
                    //L.marker(latLng).addTo(map)
                    //var polyline = L.polyline([lastLatLng, latLng], { color: 'red' }).addTo(map);

                    //var polyline = L.polyline([lastLatLng, latLng]).addTo(map);

                    var color1 = getColorForSpeed(lastVelocity);
                    var color2 = getColorForSpeed(velocity);

                    var polyline = L.hotline([
                        [lastLatLng[0], lastLatLng[1], 0],  // Dodana wartość numeryczna dla gradientu (np. 0)
                        [latLng[0], latLng[1], 1]           // Drugi punkt z wartością 1
                    ], {
                        weight: 8,                 // Grubość linii
                        opacity: 1,                // Przezroczystość linii
                        palette: {                 // Definiowanie gradientu kolorów
                            0.0: color1,           // Kolor początkowy dla wartości 0
                            1.0: color2            // Kolor końcowy dla wartości 1
                        },
                        min: 0,                    // Minimalna wartość dla gradientu
                        max: 1,                    // Maksymalna wartość dla gradientu
                        steps: 256,                // Ilość kroków przejścia kolorów
                        outlineWidth: 0  
                    }).addTo(map).bindTooltip("Prędkość: " + lastVelocity + " [km/h]");

                    polylineArray.push(polyline);

                    rideLineArray.push([lastLatLng, latLng, velocity]);

                    if (vMax < velocity){
                        vMax = velocity;
                        trackingVmax.innerHTML = `Vmax: ${vMax}km/h`
                    }
                }

                lastLatLng = latLng;
                lastVelocity = velocity;
            }

        }

        var terazTracking = "";
        var razPytane = false;
        var razPytaneWoz;

        function refreshVehicle(idVehicle, markerPole){
            if (trackingVNow == false){
                oneVehicleTab = [];
                oneVehicleTab.push(idVehicle);

                if (createRequest("partOne") == "ok"){
                    /*handshakeSelector("gps").then(odpow => {
                        alert(odpow);
                    });*/

                    /*var odpow = handshakeSelector("gps");
                    console.log("ODPOWIEDŹ: ");
                    console.log(odpow);*/


                    handshakeSelector("gps").then(odpow => {
                        console.log("ODPOWIEDŹ: ");
                        console.log(odpow);
                        
                        if (odpow == "ok_gps"){
                            console.log(getGpsData);
                            
                            updateVehiclePopup(idVehicle, markerPole, getGpsData);

                            if (trackingState){
                                trackingVNow = true;
                                aktualizacjaLoopOn(idVehicle, markerPole);   
                                trackingInfo.innerHTML = "Tracking: wóz #"+idVehicle+" <a onclick='cancelTracking()' id='calcel-a'>anuluj</a>";
                                terazTracking = idVehicle;
                            }
                        
                        }
                    });
                    
                    /*if (handshakeSelector("gps") == "ok_gps"){
                        alert("oki");
                        alert(getGpsData);
                    }*/
                }
            }
            razPytane = true;
            razPytaneWoz = RLoad;
        }

        var trackingInfo = document.getElementById("tracking-info");
        var trackingVmax = document.getElementById("tracking-vmax");
        var trackingVNow = false;

        function trackingSwitch(stan){
            if(stan == "on"){
                trackingState = true;
                konsola("info", "Successfully <span style='color: LimeGreen;'>enabled</span> tracking");
                trackingInfo.innerHTML = "Tracking: ON";
            }else if(stan == "off"){
                trackingState = false;
                cancelTracking("normal");
                konsola("info", "Successfully <span style='color: red;'>disabled</span> tracking");
                trackingInfo.innerHTML = "";
                trackingVmax.innerHTML = "";
                vMax = 0;
                //trackingVNow = false;
            }else if(stan == "offstop"){
                trackingState = false;
                cancelTracking("stop");
                konsola("info", "Successfully <span style='color: red;'>disabled</span> tracking");
                //trackingVNow = false;
            }
        }

        async function cancelTracking(wariant = "normal"){
            if (trackingVNow == true){
                if (wariant == "stop"){
                    trackingInfo.innerHTML = "Tracking: OFF";
                }else if (wariant == "normal"){
                    //trwa anulowanie komunikat
                    trackingInfo.innerHTML = "Tracking: wóz #"+terazTracking+" anulowanie...";
                    trackingVmax.innerHTML = "";
                    vMax = 0;
                    if (isFetching == true){
                        while (isFetching) {
                            await new Promise(resolve => setTimeout(resolve, 400)); // Sprawdzanie co 100ms
                            console.log("ten: " + isFetching);
                        }
                        
                    }
                    setTimeout(() =>{
                        polylineArray.forEach(polyline =>{
                            polyline.remove();
                        });
                        polylineArray = [];
                        /*rideLineArray.forEach(rline =>{
                            rline.remove();
                        });*/
                        rideLineArray = [];


                        trackingVNow = false;
                        trackingInfo.innerHTML = "Tracking: ON";
                        trackingVmax.innerHTML = "";
                        vMax = 0;
                    }, 200)
                }

                lastLatLng = [];
                lastVelocity = 0;

                //await sendRequest("15:41/vehicle_gps,");
                
            }
        }

        /*

        sendRequest(`67:42/vehicle_gps,["vehicleID","daaad901-94e8-4950-92a7-b0a46dc77677"]`);

        sendRequest(`67:42/vehicle_gps,["vehicleID","e6c0a250-f18e-470f-b1cf-eda724cf1ea3"]`);







        */

        async function aktualizacjaLoopOn(idVehicle, markerPole){
            /*var tmOut;
            while(trackingState){
                tmOut = setTimeout(() =>{
                    var odpLoop = await sendRequest(); 
                    console.log(odpLoop);
                }, 2000);
                
            }*/

            if ((Date.now() - lastSidRenew) <= (waznoscSid - 1) * 1000 || lastSidRenew == 0){
                if (trackingState && waznoscSid > 1 && trackingVNow){
                    if (!renewingSigNow){
                        try {
                            var odpLoop = await sendRequest(); // ✅ await działa poprawnie

                            console.log(odpLoop);

                            if (odpLoop != "1:3" && odpLoop != "1:1" && odpLoop != "code500"){
                                var cleanOdp = odpLoop.replace(/^\d+:\d+\/vehicle_gps,/, "");

                                odpLoopPrs = JSON.parse(cleanOdp/* + "150:42/vehicle_gps,"*/);
                                console.log(JSON.stringify(odpLoopPrs, null, 2)); // Ładne formatowanie JSON

                                updateVehiclePopup(idVehicle, markerPole, odpLoopPrs);
                            }else if(odpLoop == "1:1"){ //skasowane ponieważ już się powtarza
                                /*konsola("error", "Serwer zamknął połączenie");
                                trackingSwitch("offstop");*/
                                console.log("zreturniło BBBBBBBBBBBBBB");
                                return;
                            }
                        } catch (error) {
                            console.error("Błąd w trackingu:", error);
                        
                            trackingSwitch("offstop");
                            konsola("error", `Tracking error: ${error}`);
                            return;
                        }
                    }
                    setTimeout(() => aktualizacjaLoopOn(idVehicle, markerPole), 4000);
                    
                }
            }
        }

        /*/-----  K O N S O L A  -----/*/

        var konsolaObszar = document.getElementById('konsola-obszar');
        var konsolaPole = document.getElementById('konsola-pole');
        var konsolaInput = document.getElementById('input-console');

        function openConsole(){
            if (konsolaObszar.style.display == "none"){
                konsolaObszar.style.display = "flex";
                konsolaInput.focus();
            }else if (konsolaObszar.style.display == "flex"){
                konsolaObszar.style.display = "none";
            }
        }

        async function hashText(text){
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            
            // Algorytm hashujący SHA-256
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            
            // Konwersja wyniku do ciągu hex
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');
            
            console.log(hashHex);
            return hashHex;
        }

        //hashText("switchpanel");

        // &lt;    <
        // &gt;    >

        var komendy = {
            cmd0: [ //version
                "5ca4f3850ccc331aaf8a257d6086e526a3b42a63e18cb11d020847985b31d188",
                "U2FsdGVkX1/nQHBP5QXaySdf7xMRXim3RVSsvW+WQfM=",
                "Wyświetla informacje o wersji",
                ""
            ],
            cmd1: [ //leonard
                "b76aefa8fe4304f650962fb4af77b4db4b13d34ac9615391126027232ec16822",
                "U2FsdGVkX180tEAcXiHWceJAn/rt7WOwTBMyVC4+oO4=",
                "Pokazuje informacje o komendach",
                " &lt;hasło&gt"
            ],
            cmd2: [ //maxselect
                "18059f7c0344c3e16e510afa762954cd17dc697917a45c6bdb9207e951c2dfdb",
                "U2FsdGVkX1/4sdQOor27UEUDfmSikirLGqtbRJmkk+A=",
                "Zmienia maksymalną ilość znaznaczeń wozów (domyślnie 12)",
                " &lt;ilość&gt"
            ],
            cmd3: [ //color
                "74284d9dcbcc09928ca5d7d6187270a62ac1b58ccdc4a44b81e47257ffa53b9e",
                "U2FsdGVkX1/PZdyqDeiuwkUyFLjV1tLIm9HvzJPcvC4=",
                "Ustawianie koloru konsoli. X - kolor tła, Y - kolor tekstu. Kody kolorów 0-9, A-F. Parametr codes wypisuje wszystkie dostępne kody kolorów. Brak żadnego parametru skutkuje przywrócenie barw domyślnych.",
                " &lt;XY/codes&gt"
            ],
            cmd4: [ //exit
                "e596899f114b5162402325dfb31fdaa792fabed718628336cc7a35a24f38eaa9",
                "U2FsdGVkX18i9aq/N9B/LNtatBQ5Qzp2GGOKlYbBcv4=",
                "Zamyka konsole",
                ""
            ],
            cmd5: [ //cls
                "84cdb981037648c41f06dea25de7dcb2f26c5b965a47e8e2cc44b33e0412ad66",
                "U2FsdGVkX1/WCc5UoIrGS/Ky+hL0Srxtcs6b/borq9k=",
                "Czyści konsole",
                ""
            ],
            cmd6: [ //tracking
                "5a95db2aa8e5d0883be7b8968983b8ea67d91f1e7ae5463b97258986a93de1be",
                "U2FsdGVkX18QQaz+YtjDNgAI1YEhEesvpNTm6xfdQG0=",
                "Automatyczne śledzenie wybranego wozu",
                ""
            ],
            cmd7: [ //sidloop
                "e42913ec1db5f0672f564ffa4f82588f063b42cb05d5183518d929a1c3e17aea",
                "U2FsdGVkX18rLJC8Jok+3vPA/MH5FUqTGWXxW8k61oM=",
                "Nieskończony SID",
                ""
            ]
        };

        function encryptData(data, password) {
            return CryptoJS.AES.encrypt(data, password).toString();
        }

        function decryptData(encryptedData, password) {
            const bytes = CryptoJS.AES.decrypt(encryptedData, password);
            return bytes.toString(CryptoJS.enc.Utf8);
        }

        /*  Funkcja deweloperska do tworzenia nowych komend  */
        async function newCommand(commandTag, hasloDoSzyfru){
            if (commandTag && hasloDoSzyfru){
                console.log("##########");
                console.log("Komenda: " + commandTag);
                console.log("Hash: " + await hashText(commandTag));
                console.log("Szyfr: " + encryptData(commandTag, hasloDoSzyfru));
                console.log("##########");
            }
        }

        newCommand("sidloop", "szczecinski105N");

        //console.log(encryptData("leonard", "szczecinski105N"));
        //console.log(decryptData(komendy.cmd2[1], "szczecinski105Nb"))

        const colorCodes = {
            "0": ["#000000", "Black"], // Czarny
            "1": ["#000080", "Blue"], // Niebieski
            "2": ["#008000", "Green"], // Zielony
            "3": ["#008080", "Aqua"], // Turkusowy
            "4": ["#800000", "Red"], // Czerwony
            "5": ["#800080", "Purple"], // Purpurowy
            "6": ["#808000", "Yellow"], // Żółty
            "7": ["#C0C0C0", "White"], // Biały
            "8": ["#808080", "Gray"], // Szary
            "9": ["#0000FF", "Light Blue"], // Jasnoniebieski
            "a": ["#00FF00", "Light Green"], // Jasnozielony
            "b": ["#00FFFF", "Light Aqua"], // Jasnoturkusowy
            "c": ["#FF0000", "Light Red"], // Jasnoczerwony
            "d": ["#FF00FF", "Light Purple"], // Jasnopurpurowy
            "e": ["#FFFF00", "Light Yellow"], // Jasnożółty
            "f": ["#FFFFFF", "Bright White"]  // Jasna biel
        };

        var version = "0.2";

        var logColor = "white"; //#C0C0C0

        function setConsoleColor(backgroundKolor, fontKolor){
            if (backgroundKolor && fontKolor){
                konsolaPole.style.backgroundColor = backgroundKolor;
                konsolaObszar.style.backgroundColor = backgroundKolor;
                konsolaInput.style.backgroundColor = backgroundKolor;
                konsolaInput.style.color = fontKolor;
                logColor = fontKolor;

                const wpisyKonsoli = document.querySelectorAll('.konsola-wpis');
                wpisyKonsoli.forEach(wpis => {
                    if (wpis.getAttribute("logType") != "error"){
                        wpis.style.color = fontKolor;
                        const spans = wpis.querySelectorAll('span');
                        spans.forEach(span => {
                            if (span.style.color) {
                                span.style.color = span.style.color;
                            }
                        });
                    }
                });
            }
        }


        function komenda(command){
            if (command){
                if (command[0] === "/"){
                    command = command.slice(1);
                }
                var znaleziono = false;
                var jakiCmd = "";

                var parts = command.split(' ');
                var commandKey = parts[0].toLowerCase();
                var parameter = parts.slice(1).join(' ');

                hashText(commandKey).then(commandHash =>{
                    for (var cmd in komendy) {
                        if (Array.isArray(komendy[cmd]) && komendy[cmd][0] === commandHash) {
                            console.log(cmd);
                            znaleziono = true;
                            jakiCmd = cmd;
                            break;
                        }
                    }

                    if (znaleziono && jakiCmd){
                        if(jakiCmd == "cmd0"){
                            konsola("info", "-------------  <span style='color: orange;'>VERSION CONTROL</span>  -------------");
                            konsola("info", "MPKCHEATS Shell");
                            konsola("info", "LATEST RELEASED VERSION:");
                            konsola("info", `UNSTABLE <span style="color: orange;">${version}</span>`);
                        }else if(jakiCmd == "cmd1"){
                            if (parameter){
                                var okPassword = false;
                                try{
                                    var testPassw = decryptData(komendy[cmd][1], parameter);
                                    if (testPassw && testPassw != ""){
                                        okPassword = true;
                                    }
                                } catch(e){
                                    konsola("info", "Bad password to the command list.");
                                    konsolaPole.scrollTop = konsolaPole.scrollHeight;
                                }
                                if (okPassword){
                                    //console.log("tutaj1234");

                                    konsola("info", "-------------  <span style='color: orange;'>HELP MENU</span>  -------------");
                                    konsola("info", "")

                                    for (var cmd in komendy) {
                                        var tablicaSzyfru = komendy[cmd];
                                        var mozliweParametry = tablicaSzyfru[3];
                                        try{
                                            var decryptedSzyfr = decryptData(tablicaSzyfru[1], parameter);
                                            console.log(decryptedSzyfr);
                                            konsola("info", `<span style='color: orange'>/${decryptedSzyfr}${tablicaSzyfru[3]}</span> - ${tablicaSzyfru[2]}`);
                                        } catch(e){
                                            konsola("warn", "Caught an error while displaying help");
                                            konsolaPole.scrollTop = konsolaPole.scrollHeight;
                                            break;
                                        }
                                    }
                                }else{
                                    konsola("info", "Bad password to the command list.");
                                    konsolaPole.scrollTop = konsolaPole.scrollHeight;
                                }
                            }else{
                                konsola("info", "Missing or incorrect parameter. Use the help command to see the correct usage and required parameters.");
                                konsolaPole.scrollTop = konsolaPole.scrollHeight;
                            }
                        }else if (jakiCmd == "cmd2"){
                            if (parameter && parameter.length < 3){
                                var paramNumber = Number(parameter);
                                if ((typeof paramNumber === "number") && paramNumber > 0 && paramNumber <= 32){
                                    maxSelectNumber = paramNumber;
                                    sumaSelectDsp.innerHTML = `<p id="suma-p"><span id="suma-bold">SUMA: </span>${selectedVehiclesTab.length} / ${maxSelectNumber}</p>`;
                                    maxChecker();
                                    konsola("info", "Succesfull set max select number to " + paramNumber);
                                }else{
                                    konsola("info", "Max select number must be in the range 1-32");
                                }
                            }else{
                                konsola("info", "Missing or incorrect parameter. Use the help command to see the correct usage and required parameters.");
                                konsolaPole.scrollTop = konsolaPole.scrollHeight;
                            }
                        }else if (jakiCmd == "cmd3"){
                            if (parameter){
                                if (parameter.length === 2){
                                    parameter = parameter.toLowerCase();
                                    console.log(parameter);
                                    var backgroundCode = parameter[0];
                                    var fontCode = parameter[1];
                                    if (colorCodes[backgroundCode]?.[0] && colorCodes[fontCode]?.[0]) {
                                        var backgroundKolor = colorCodes[backgroundCode][0];
                                        var fontKolor = colorCodes[fontCode][0];
                                        if (backgroundKolor && fontKolor && backgroundKolor != fontKolor){

                                            setConsoleColor(backgroundKolor, fontKolor);


                                        }else{
                                            konsola("info", "Missing or incorrect parameter. Use the help command to see the correct usage and required parameters.");
                                            konsolaPole.scrollTop = konsolaPole.scrollHeight;
                                            console.log();
                                            
                                        }
                                    }else{
                                        konsola("info", "Missing or incorrect parameter. Use the help command to see the correct usage and required parameters.");
                                        konsolaPole.scrollTop = konsolaPole.scrollHeight;
                                    }
                                }else if (parameter == "codes"){
                                    //Wyświetlanie kodów
                                    konsola("info", "-------------  <span style='color: orange;'>COLOR CODES</span>  -------------");
                                    konsola("info", "CODE    |    COLOR");

                                    for (var kod in colorCodes){
                                        var kolor = colorCodes[kod][1];
                                        konsola("info", `${kod}       =    <span style="color: ${colorCodes[kod][0]};">${kolor}</span>`);
                                    }
                                }else{
                                    konsola("info", "Missing or incorrect parameter. Use the help command to see the correct usage and required parameters.");
                                    konsolaPole.scrollTop = konsolaPole.scrollHeight;
                                }
                            }else{
                                //Przywracanie domyślnego koloru
                                setConsoleColor("#000000", "#FFFFFF");
                            }
                        }else if (jakiCmd == "cmd4"){
                            konsolaObszar.style.display = "none";
                        }else if (jakiCmd == "cmd5"){
                            konsolaPole.innerHTML = "";
                        }else if (jakiCmd == "cmd6"){
                            if (trackingState){
                                trackingSwitch("off");
                            }else if (!trackingState){
                                trackingSwitch("on");
                            }
                        }else if (jakiCmd == "cmd7"){
                            if (sidLoop){
                                sidLoop = false;
                                konsola("info", "Successfully <span style='color: red;'>disabled</span> SID loop");
                            }else if (!sidLoop){
                                sidLoop = true;
                                konsola("info", "Successfully <span style='color: LimeGreen;'>enabled</span> SID loop");
                            }
                        }
                    }else{
                        konsola("info", "Unknown command. Type the help command for help.");
                        konsolaPole.scrollTop = konsolaPole.scrollHeight;
                    }
                });

            }else{
                console.log("Niezdefiniowano komendy do wywołania");
            }
        }

        var insertStamp = "&gt; ";
        //var insertStamp = "C:&#92;Users&#92;Marcin>";

        konsolaInput.addEventListener('keydown', function(e){
            if (e.key === "Enter"){
                if (konsolaInput.value){
                    console.log("Komenda: " +  konsolaInput.value);
                    konsolaPole.innerHTML += `<p class='konsola-wpis' style="color: ${logColor}">${insertStamp}${konsolaInput.value}</p>`;
                    komenda(konsolaInput.value);
                    konsolaInput.value = "";
                    konsolaPole.scrollTop = konsolaPole.scrollHeight;
                }
            }
        })

        var konsolaLoaded = false;

        function loadKonsola(){
            if (!konsolaLoaded){
                var v = " " + version;

                konsolaPole.innerHTML += `<p class="konsola-wpis" style="line-height: 1.5">   ╔══════════════════════════════╗</p>`;
                konsolaPole.innerHTML += `<p class="konsola-wpis" style="line-height: 1.5">   │  WELCOME TO MPKCHEATS Shell  │</p>`;
                konsolaPole.innerHTML += `<p class="konsola-wpis" style="line-height: 1.5">   │         VERSION ${v}         │</p>`;
                konsolaPole.innerHTML += `<p class="konsola-wpis" style="line-height: 1.5">   ╚══════════════════════════════╝</p>`;

                konsolaPole.innerHTML += `<p class="konsola-wpis" style="line-height: 1.5"><br>        <a id="lm-page" href="https://live.mpk.czest.pl/" target="_blank">Official liveMpk page</a></p>`;
                konsolaPole.innerHTML += `<p class="konsola-wpis" style="line-height: 1.5">     <a id="lm-page" href="https://live.mpk.czest.pl/api/vehicles" target="_blank">Check all current vehicles ID</a></p>`;
                konsolaPole.innerHTML += `<p class="konsola-wpis" style="line-height: 1.5"> ──────────────────────────────────</p>`;

                konsolaLoaded = true;
            }
        }

        loadKonsola();

        function konsola(logType, txtToPrint){
            if (logType && txtToPrint){
                var terazCzas = convertTime(new Date()).time;
                var logTypeMsg = "";
                var logTypeColor = "gray";
                var logArrow = "";
                var logColor = "white"; //added

                if (logType == "request"){
                    logTypeMsg = "REQUEST ";
                    logTypeColor = "green";
                    logArrow = " → ";
                }else if (logType == "response"){
                    logTypeMsg = "RESPONSE";
                    logTypeColor = "blue";
                    logArrow = " ← ";
                }else if (logType == "info"){
                    logTypeMsg = "INFO";
                    logArrow = ": ";
                }else if (logType == "warn"){
                    logTypeMsg = "WARN";
                    logColor = "yellow";
                    logTypeColor = "yellow";
                    logArrow = ": ";
                }else if (logType == "error"){
                    logTypeMsg = "ERROR";
                    logColor = "red";
                    logTypeColor = "red";
                    logArrow = ": ";
                }else{
                    console.log("Nieoczekiwany typ logu");
                    return;
                }

                konsolaPole.innerHTML += `<p class="konsola-wpis" style="color: ${logColor}" logType="${logType}">[${terazCzas}] [<span style="color: ${logTypeColor}">${logTypeMsg}</span>]${logArrow}${txtToPrint} </p>`;
                //console.log("Odpowiedź serwera:", txtToPrint);
            }
        }

        konsola("info", "Loading JSON files...");


        //AUTO TESTY
        /*for (i = 0; i<3; i++){

            konsola("request", "17:40/vehicles_exec,");
            konsola("response", "ok");

            konsola("request", "Without body");
            konsola("response", "17:40/vehicles_exec,");

            konsola("request", "421:42/vehicles_exec,[\"vehicles\",[\"7da4b67c-6349-468e-a708-91c61d854fde\",\"3cbae894-732f-4ee8-a587-ca6862281b54\",\"cc5c908d-52a0-4054-ab70-e9c6d9927b0c\",\"c4aac308-8f98-4ab1-85e6-ff16a02cf430\",\"68bcf4d1-7feb-4f73-8413-aa73814f22de\",\"b5631268-8c6b-4ff2-b9ad-06c450a93d8a\",\"47e83eb6-d67c-45cc-8d18-0b22277b1f51\",\"96fd61d8-9b2e-4bcd-a931-617ed7e5c8ed\",\"c29cd2b3-7307-4deb-b323-048fadaa4a6f\",\"39da3aab-9713-41ca-a28a-c706a909714a\"]]");
            konsola("response", "ok");

            konsola("request", "Without body");
            konsola("response", "Sukces! Odebrano prawidłowe dane JSON");

            konsola("request", "17:40/vehicles_exec,");
            konsola("response", "{\"code\":1,\"message\":\"Session ID unknown\"}");

            konsola("request", "17:40/vehicles_exec,");
            konsola("response", "ok");

            konsola("request", "Without body");
            konsola("response", "17:40/vehicles_exec,");

            konsola("request", "109:42/vehicles_exec,[\"vehicles\",[\"386591df-c783-473c-af9f-0aa03752dbda\",\"7f75fb31-4a50-4c28-8576-7028a99ab80b\"]]");
            konsola("response", "ok");

            konsola("request", "Without body");
            konsola("response", "Sukces! Odebrano prawidłowe dane JSON");

            konsola("request", "17:40/vehicles_exec,");
            konsola("response", "{\"code\":1,\"message\":\"Session ID unknown\"}");

            konsola("request", "17:40/vehicles_exec,");
            konsola("response", "ok");

            konsola("request", "Without body");
            konsola("response", "17:40/vehicles_exec,");

            konsola("request", "70:42/vehicles_exec,[\"vehicles\",[\"a8c4ceff-3ac5-4ba3-b101-9abd4f922fae\"]]");
            konsola("response", "ok");

            konsola("request", "Without body");
            konsola("response", "Sukces! Odebrano prawidłowe dane JSON");

        }*/








        //Pobieranie i obsługa SID
        let sid = null;
        var odliczanieWaznosci;
        const waznoscSid = 25;
        var aktualnaWaznosc = 0;
        var spanWaznosciSid = document.getElementById("waznosc-sid-span");

        var sidStreak = 0;
        var lastSidRenew = 0;

        var sidLoop = false;

        function startCountingSid(action){
            if (action == "start"){
                clearInterval(odliczanieWaznosci);
                aktualnaWaznosc = waznoscSid;
                spanWaznosciSid.innerHTML = aktualnaWaznosc;

                sidStreak = 0;
                lastSidRenew = 0;
                odliczanieWaznosci = setInterval(() =>{
                    let temporState;
                    if ((Date.now() - lastSidRenew) <= (waznoscSid - 1) * 1000 || lastSidRenew == 0){
                        temporState = true; //zgoda
                        console.log(temporState);

                        
                        //dane dump


                    }else{
                        temporState = false; //brak zgody
                        console.log(temporState);
                    }
                    konsola("warn", temporState);
                    if (temporState === true){
                        aktualnaWaznosc--;
                        spanWaznosciSid.innerHTML = aktualnaWaznosc;
                        document.title = "SID " + aktualnaWaznosc;
                        if (aktualnaWaznosc <= 4 && (trackingState || sidLoop)){
                            renewSid();
                        }
                    }
                    if (aktualnaWaznosc <= 0 || temporState === false){
                        clearInterval(odliczanieWaznosci);

                        sid = null;
                        aktualnaWaznosc = 0;
                        spanWaznosciSid.innerHTML = aktualnaWaznosc;

                        if(trackingState == true){
                            trackingSwitch("offstop");
                        }

                        razPytane = false;

                        console.log("WAŻNOŚĆ SID SIĘ SKOŃCZYŁA");
                        document.title = "KONIEC SID";

                    }
                }, 1000)
            }
        }

        var renewingSigNow = false;


        async function renewSid(){
            renewingSigNow = true;
            var response = await sendRequest("1:2");
            if (response == "ok"){
                try{
                    await sendRequest();  

                    startCountingSid("start");
                    setTimeout(() =>{
                        renewingSigNow = false;  
                    }, 400);

                    sidStreak++;
                    lastSidRenew = Date.now();
                }catch(error){
                    console.log("ERROR SID");
                }
            
                
            }
        }


        /*let renewingSigNow = false;

        function startCountingSid(action) {
            if (action === "start") {
                clearTimeout(odliczanieWaznosci); // Usunięcie poprzedniego odliczania
                aktualnaWaznosc = waznoscSid;
                spanWaznosciSid.innerHTML = aktualnaWaznosc;

                function countdown() {
                    if (aktualnaWaznosc <= 0) {
                        sid = null;
                        console.log("WAŻNOŚĆ SID SIĘ SKOŃCZYŁA");
                        return; // Zakończ funkcję
                    }

                    aktualnaWaznosc--;
                    spanWaznosciSid.innerHTML = aktualnaWaznosc;

                    if (aktualnaWaznosc <= 4 && trackingState && !renewingSigNow) {
                        renewSid();
                    }

                    odliczanieWaznosci = setTimeout(countdown, 1000); // Ponowne wywołanie po 1s
                }

                countdown(); // Uruchomienie licznika
            }
        }
        async function renewSid() {
            if (renewingSigNow) return; // Jeśli już odnawiamy, przerwij

            renewingSigNow = true;
            try {
                let response = await sendRequest("1:2");
                if (response === "ok") {
                    await sendRequest();
                    startCountingSid("start");
                }
            } catch (error) {
                console.error("Błąd odnawiania SID:", error);
            } finally {
                setTimeout(() => {
                    renewingSigNow = false;
                }, 400);
            }
        }*/


        async function getSid(){
            try {
                var startMsSid = performance.now();
                var response = await fetch("https://live.mpk.czest.pl/socket.io/?EIO=3&transport=polling");
                var stopMsSid = performance.now();
                var reqTimeSid = Math.round(stopMsSid - startMsSid);
                konsola("request", "SID request sended");
                if (response.status == 200){
                    var sidColorStatus = "green";
                }

                var text = await response.text();
                konsola("response", `[${reqTimeSid}ms, <span style="color: ${sidColorStatus}">${response.status}</span>] ` + text);
                var sidMatch = text.match(/"sid":"([^"]+)"/);
                if (sidMatch) {
                    sid = sidMatch[1];
                    document.cookie = `io=${sid}; path=/;`;
                    console.log("Uzyskano SID:", sid);
                    startCountingSid("start");
                    konsola("info", "Received matching sid: " + sid);
                    
                } else {
                    throw new Error("Nie udało się uzyskać SID.");
                }
            } catch (error) {
                console.error("Błąd podczas pobierania SID:", error);
            }
        }

        document.getElementById("fetchSid").addEventListener("click", () => {
            getSid();
        });

        //Funkcja do generowania zmiennej &t
        function generateRandomT() {
            /*const characters = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 12; i++) { // Losowa długość ciągu
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;*/


            var tValueGen = Date.now().toString(36); // Konwersja znacznika czasu na zapis base36
            //console.log(tValue);

            return tValueGen;
        }


        // Funkcja do wysyłania żądania
        var reqTime = 0;
        var rStatus;
        var statusColor = "white";
        var isFetching = false;

        async function sendRequest(payload) {
            if (!sid) {
                await getSid();
            }
            const url = `https://live.mpk.czest.pl/socket.io/?EIO=3&transport=polling&t=${generateRandomT()}&sid=${sid}`;
            try {
                if (payload != null){
                    isFetching = true;
                    var startMs = performance.now();
                    response = await fetch(url, {
                        method: "POST",
                        credentials: 'include',
                        headers: {
                            "Content-Type": "text/plain",
                            "Connection": "keep-alive"
                        },
                        body: payload
                    });
                    var stopMs = performance.now();
                    isFetching = false;
                }else{
                    isFetching = true;
                    var startMs = performance.now();
                    response = await fetch(url, {
                        method: "GET",
                        credentials: 'include',
                        headers: {
                            "Content-Type": "text/plain",
                            "Connection": "keep-alive"
                        }
                    }); 
                    var stopMs = performance.now();
                    isFetching = false;
                }
                reqTime = Math.round(stopMs - startMs);
                if (payload){
                    if (payload.length < 430){
                        konsola("request", payload);
                    }else{
                        konsola("request", "Wysłano długie zapytanie");
                    }
                }else{
                    konsola("request", "Request without set body");

                }

                const resultText = await response.text();

                statusColor = "white";
                rStatus = response.status;
                var rTextPrep = resultText;

                console.log(rStatus);

                if (rStatus == 200){
                    statusColor = "green";
                }else if (rStatus == 500){
                    statusColor = "red";
                    rTextPrep = "code500";
                }

                if (rTextPrep.length < 200){
                    konsola("response", `[${reqTime}ms, <span style="color: ${statusColor}">${rStatus}</span>] ` + resultText);
                }

                if (resultText == "1:1"){
                    konsola("error", "Serwer zamknął połączenie");
                    trackingSwitch("offstop");
                    rTextPrep = "1:1";
                    aktualnaWaznosc = "0";
                    sid = null;
                }

                console.log("tenteges00000000: " + rTextPrep);
                return rTextPrep;
            } catch (error) { //jednak to coś chyba daje
                console.error("Błąd podczas wysyłania żądania:", error);
                return "code500";
            }
        }

        // Przyciski do wysyłania zapytań
        document.getElementById("sendRequest").addEventListener("click", () => {
            sendRequest("17:40/vehicles_exec,");
        });


        document.getElementById("sendRequest2").addEventListener("click", () => {
            var tempSR = `109:42/vehicles_exec,["vehicles",["b84e6ec0-8b0a-498f-a7c2-4aeabe296cae","9c1f6e28-dd83-4f4a-8317-8c891ca17fe8"]]`;


            //sendRequest("fsj5m33j6n49", "109:42/vehicles_exec,['vehicles',['c29cd2b3-7307-4deb-b323-048fadaa4a6f','c29cd2b3-7307-4deb-b323-048fadaa4a6f']]");
            sendRequest(tempSR);
        });

        document.getElementById("sendRequest3").addEventListener("click", () => {
            sendRequest();
        });





        //  41/vehicles_exec,


        /*function gsid(){
            const url = "wss://live.mpk.czest.pl/socket.io/?EIO=3&transport=websocket&sid="+sid;

            socket = new WebSocket(url);

            socket.addEventListener('open', (event) => {
                console.log("Połączono z serwerem");

                socket.send("2probe");
            });

            socket.addEventListener('message', (event) => {
                console.log("Otrzymano: ", event.data);
                var prefix = "42/vehicles_exec,";
                if (event.data == "3probe"){
                    //Tutaj, dalej zrobić automatyczne przypominanie 2, i koniec sesji
                    socket.send("5");

                }else if (event.data.startsWith(prefix)){
                    var cleanData = event.data.replace(prefix, "");

                    // Parsujemy dane JSON
                    try {
                        const getData = JSON.parse(cleanData);
                        console.log(JSON.stringify(getData, null, 2)); // Ładne formatowanie JSON
                    } catch (error) {
                        console.error("Błąd parsowania JSON:", error);
                    }


                    console.log(JSON.stringify(getData, null, 2)); // Ładne formatowanie JSON
                }

            });

            // Obsługa błędów
            socket.addEventListener('error', (event) => {
                console.error("Błąd: ", event);
            });

            // Obsługa zamknięcia połączenia
            socket.addEventListener('close', (event) => {
                console.log("Połączenie zamknięte");
            });

        }*/

        var input = document.getElementById('input');

        /*function send(){
            socket.send(input.value);
        }*/


        var getData;


        fetch('jsonmirek.txt')
            .then((response) => response.json())
            .then(json => {
                getData = json;
            })
            .catch(error => console.error('Błąd:', error));


        function vehicleId(tabor){
            if (vehiclesJson != undefined){
                var find = vehiclesJson.slice().reverse().find(item => item.sideNo == tabor);
                if (find){
                    return(find.vehicleID);
                } else{
                    console.log('Nie zalneziono elementu ' + tabor);
                }
            }
        }

        var qBook = {
            "porecz": [
                "177", "178", "179", "180", "181", "182", "183", "184"
            ],
            "105":[
                "611/612", "613/614", "615/616", "644/645", "648/649", "684/688", "695/697"
            ],
            "krakus":[
                "220", "222", "223", "224", "225", "226", "227", "228", "229", "231"
            ],
            "128":[
                "128"
            ],
            "219":[
                "219"
            ],
            "218":[
                "218"
            ]
            
        }

        //Metoda, czyli co chcemy pobrać z autoQ() (exec/gps)
        var method = "exec";

        //Obiekt z szablonami i wiadomościami do serwera socket
        var msgLib = {
            "execBaseStart": `42/vehicles_exec,["vehicles",[`,
            "execBaseEnd": "]]",

            "execInit": "17:40/vehicles_exec,",
            "execEvent": "42/vehicles_exec,",
            "execClose": "17:41/vehicles_exec,",


            "gpsBaseStart": `42/vehicle_gps,["vehicleID",`,
            "gpsBaseEnd": "]",

            "gpsInit": "15:40/vehicle_gps,",
            "gpsEvent": "42/vehicle_gps,",
            "gpsClose": "15:41/vehicle_gps,",
        };

        var RLoad;
        
        //Funkcja do tworzenia kwerend, z ustalonych zbiorów wozów
        function autoQ(set, dataMethod = method){
            if (qBook.hasOwnProperty(set)){
                if (dataMethod == "exec" || dataMethod == "gps"){
                    var qStart = msgLib[`${dataMethod}BaseStart`];
                    var qEnd = msgLib[`${dataMethod}BaseEnd`];


                    var constructQuery = qStart;
                    qBook[set].forEach((taborWoz, index) =>{
                        //dalej kwerenda
                        constructQuery += `"${vehicleId(taborWoz)}"`;
                        if (index < qBook[set].length - 1) {
                            constructQuery += ",";
                        }
                    })
                    constructQuery += qEnd;
                    var qTag = constructQuery.length + ":";
                    constructQuery = qTag + constructQuery;

                    console.log(constructQuery);
                    RLoad = constructQuery;
                }else{
                    konsola("error", `Error in autoQ() function: Unknown data fetching method ${dataMethod}`);
                }
            }else{
                konsola("error", `Error in autoQ() function: Undefined vehicle set ${set}`);
            }
        }


        //zasyncować to


        //Wybierak rodzaju połączenia i pobrania danych
        async function handshakeSelector(type){
            if (RLoad != undefined){
                if (sid  && aktualnaWaznosc > 0){
                    var zwrot = await wshandshake(type, "short");
                    console.log(zwrot);
                    return zwrot;
                    //short
                }else{
                    var zwrot = await wshandshake(type, "long");
                    console.log(zwrot);
                    return zwrot;
                    
                }
            }
        }

        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        //Funkcja połączenia krótka
        /*async function wshandshakeShort(type, values){
            if (2+2 == 4){
                if (type == "exec"){
                    await sendRequest("17:40/vehicles_exec,");
                    await delay(40);
                    await sendRequest();
                    await delay(20);
                    var request3 = await sendRequest(RLoad);
                    if (request3 == "ok"){
                        await delay(20);
                        var request4 = await sendRequest();
                        var prefix = "42/vehicles_exec,";
                        if (request4.includes(prefix)){
                            console.log("%c All ok", "color: green");
                            var cleanData = request4.replace(/^\d+:\d+\/vehicles_exec,/, "");
                            // Parsujemy dane JSON
                            try {
                                getData = JSON.parse(cleanData);
                                console.log(JSON.stringify(getData, null, 2)); // Ładne formatowanie JSON

                                //await sendRequest("1:1");

                                konsola("response", `[${reqTime}ms, <span style="color: ${statusColor}">${rStatus}</span>] <span style='color: LimeGreen'>Sukces!</span> Odebrano prawidłowe dane JSON`);
                                processVData();

                                await sendRequest("17:41/vehicles_exec,");
                                //await sendRequest();
                            } catch (error) {
                                console.error("Błąd parsowania JSON:", error);
                            }
                        }else{
                            console.log("Błąd żądania 4: "+request4);
                            console.log("TUTAJ: " + request4);
                        }
                    }else{
                        console.log("Błąd żądania 3: "+request3);
                    }

                }
            }
        }*/


        //Funkcja połączenia i pobrania danych
        async function wshandshake(type, variant){
            if (variant){
                if (type == "exec" || type == "gps"){
                    var qInit = msgLib[`${type}Init`];
                    var qEvent = msgLib[`${type}Event`];
                    var qClose = msgLib[`${type}Close`];

                    if (type == "exec"){ //nietest
                        razPytane = false;
                    }

                    if (type == "gps" && razPytane == true && (trackingState == true || razPytaneWoz == RLoad)){
                        var request1 = "ok";
                        console.log("SHORT");
                    }else{
                        var request1 = await sendRequest(qInit);
                    }
                    if (request1 == "ok"){
                        var request2 = await sendRequest();
                        if ((variant == "short" && request2) || (request2 == qInit)){
                            //var RLoad = `109:42/vehicles_exec,["vehicles",["90bec8e0-96da-4677-a7ba-d86ce58e4cd9","dabbd6d4-e56e-4d76-addc-de11367578f9"]]`;

                            var request3 = await sendRequest(RLoad);
                            if (request3 == "ok"){
                                var request4 = await sendRequest();
                                var prefix = qEvent;
                                if (request4.includes(prefix)){
                                    console.log("%c All ok", "color: green");
                                    if(type == "exec"){
                                        var cleanData = request4.replace(/^\d+:\d+\/vehicles_exec,/, "");
                                    }else if(type == "gps"){
                                        var cleanData = request4.replace(/^\d+:\d+\/vehicle_gps,/, "");
                                    }

                                    konsola("response", `Odebrano dane właściwe. Tryb: ${type}`);

                                    if (type == "exec"){
                                        // Parsujemy dane JSON
                                        try {
                                            getData = JSON.parse(cleanData/* + "150:42/vehicles_exec,"*/);
                                            console.log(JSON.stringify(getData, null, 2)); // Ładne formatowanie JSON

                                            //await sendRequest("1:1");

                                            konsola("info", `[${reqTime}ms, <span style="color: ${statusColor}">${rStatus}</span>] <span style='color: LimeGreen'>Sukces!</span> Prawidłowo sparsowano dane exec JSON`);
                                            processVData();

                                            await sendRequest(qClose);
                                            //await sendRequest();
                                        } catch (error) {


                                            //uncomment
                                            console.error("Błąd parsowania JSON:", error);


                                            konsola("error", `JSON parsing error: ${error}`);
                                            komunikat({
                                                wariant: "error",
                                                title: "Błąd pobierania danych!",
                                                content: "Spróbuj ponownie! Skrypt otrzymał niepoprawne dane exec z serwera LIVE MPK."
                                            });
                                        }
                                    }else if (type == "gps"){
                                        // Parsujemy dane JSON
                                        try {
                                            getGpsData = JSON.parse(cleanData/* + "150:42/vehicle_gps,"*/);
                                            console.log(JSON.stringify(getGpsData, null, 2)); // Ładne formatowanie JSON

                                            //await sendRequest("1:1");

                                            konsola("info", `[${reqTime}ms, <span style="color: ${statusColor}">${rStatus}</span>] <span style='color: LimeGreen'>Sukces!</span> Prawidłowo sparsowano dane gps JSON`);
                                            


                                            /*if (!trackingState){
                                                await sendRequest(qClose);
                                            }*/
                                            //await sendRequest();

                                            return "ok_gps";
                                        } catch (error) {
                                            //console.error("Błąd parsowania JSON:", error);
                                            konsola("error", `JSON parsing error: ${error}`);
                                            komunikat({
                                                wariant: "error",
                                                title: "Błąd pobierania danych!",
                                                content: "Spróbuj ponownie! Skrypt otrzymał niepoprawne dane gps z serwera LIVE MPK."
                                            });
                                        }
                                    }



                                    //Tymczas po co
                                    //await sendRequest(qClose);




                                    //console.log(JSON.stringify(getData, null, 2)); // Ładne formatowanie JSON
                                }else{
                                    console.log("Błąd żądania 4: "+request4);
                                    console.log("TUTAJ: " + request4);
                                } //starts with
                            }else{
                                console.log("Błąd żądania 3: "+request3);
                            }
                        }else{
                            console.log("Błąd żądania 2: "+request2);
                        }
                    }else{
                        console.log("Błąd żądania 1: "+request1);
                    }
                }
            }else{
                konsola("error", "Variant parameter is not set in wshandshake() function");
            }
        }

        var vehiclesJson;

        fetch('../data/vehicles.json')
            .then((response) => response.json())
            .then(json => {
                vehiclesJson = json;
                console.log('Pobrano vehicles.json '+ vehiclesJson.length);
                konsola("info", `<span class="loaded-span">Loaded vehicles.json:   ${vehiclesJson.length} vehicles</span>`);

            })
            .catch(error => console.error('Błąd:', error));

        function vehicles(vehicleID){
            if (vehiclesJson != undefined){
                var find = vehiclesJson.find(item => item.vehicleID == vehicleID)
                if (find){
                    return(find.sideNo);
                } else{
                    console.log('Nie zalneziono elementu ' + vehicleID);
                }
            }
        }

        var driversJson;

        fetch('../data/drivers.json')
            .then((response) => response.json())
            .then(json => {
                driversJson = json;
                console.log('Pobrano drivers.json '+ driversJson.drivers.length);
                console.log(driversJson);
                konsola("info", `<span class="loaded-span">Loaded drivers.json:     ${driversJson.drivers.length} drivers</span>`);

            })
            .catch(error => console.error('Błąd:', error));

        function drivers(driverID){
            if (driverID != undefined){
                var driver = driversJson.drivers.find(driver => driver.driverID === driverID);
                
                if (driver) {
                    return driver;
                }
            }
        }

        var locJson;

        fetch('../data/locations.json')
            .then((response) => response.json())
            .then(json => {
                locJson = json;
                console.log('Pobrano locations.json '+ locJson.length);
                konsola("info", `<span class="loaded-span">Loaded locations.json: ${locJson.length} locations</span>`);

            })
            .catch(error => console.error('Błąd:', error));

        function locations(locationID, textPaste = false){
            if (locJson != undefined){
                var find = locJson.find(item => item.locationID == locationID)
                if (find){
                    if (find.name == ""){
                        if(textPaste == true){
                            return(`<span class="old-stop" title="Przystanek zlikwidowany lub przeniesiony">${find.description}</span>`);
                        }else{
                            return(find.description); //CHANGED  + " | " + locationID
                        }
                    }
                    else{
                        return(find.name);
                    }
                    
                } else{
                    console.log('Nie zalneziono elementu ' + locationID);
                }
            }
        }

        var linesJson;

        fetch('../data/lines.json')
            .then((response) => response.json())
            .then(json => {
                linesJson = json;
                console.log('Pobrano lines.json '+ linesJson.length);
                konsola("info", `<span class="loaded-span">Loaded lines.json:       ${linesJson.length} lines</span>`);

            })
            .catch(error => console.error('Błąd:', error));

        function lines(lineID){
            if (linesJson != undefined){
                var find = linesJson.find(item => item.lineID == lineID)
                if (find){
                    return(find.name);
                } else{
                    console.log('Nie zalneziono elementu ' + lineID);
                }
            }
        }

        function convertTime(isoDate) {
            var date = new Date(isoDate);

            var optionsDate = { year: 'numeric', month: '2-digit', day: '2-digit' };
            var optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit' };

            var formattedDate = date.toLocaleDateString('pl-PL', optionsDate);
            var formattedTime = date.toLocaleTimeString('pl-PL', optionsTime);
            var formattedDateTime = `${formattedDate}, ${formattedTime}`;

            return {
                date: formattedDate,
                time: formattedTime,
                dateTime: formattedDateTime
            };
        }
        function isToday(dateToCheck) {
            // Jeśli data jest stringiem, próbujemy ją sparsować
            if (typeof dateToCheck === "string") {
                const [day, month, year] = dateToCheck.split('.').map(Number);
                dateToCheck = new Date(year, month - 1, day); // Tworzymy obiekt Date
            }
            
            // Walidacja: Sprawdzamy, czy data jest poprawnym obiektem Date
            if (!(dateToCheck instanceof Date) || isNaN(dateToCheck.getTime())) {
                console.error("Nieprawidłowa data:", dateToCheck);
                return false;
            }

            // Pobieramy dzisiejszą datę
            const today = new Date();
            return dateToCheck.getFullYear() === today.getFullYear() &&
                dateToCheck.getMonth() === today.getMonth() &&
                dateToCheck.getDate() === today.getDate();
        }

        var dataDsp = document.getElementById('data-dsp');
        var liveDataDsp = document.getElementById('live-data-dsp');


        function changeTime(timeArg){
            var [data, time] = timeArg.split(", ");
            var [day, month, year] = data.split(".");
            var [hour, minute, second] = time.split(":");

            var timeObject = new Date(
                parseInt(year, 10),      // Rok
                parseInt(month, 10) - 1, // Miesiące są indeksowane od 0
                parseInt(day, 10),       // Dzień
                parseInt(hour, 10),      // Godzina
                parseInt(minute, 10),    // Minuta
                parseInt(second, 10)     // Sekunda
            );

            return timeObject;
        }


        const unitForms = {
            seconds: ["sekunda", "sekundy", "sekund"],
            minutes: ["minuta", "minuty", "minut"],
            hours: ["godzina", "godziny", "godzin"],
            days: ["dzień", "dni", "dni"],
            months: ["miesiąc", "miesiące", "miesięcy"],
            years: ["rok", "lata", "lat"]
        };

        function timeForm(time, number){
            console.log(time + " | " + number);
            if (number % 10 === 1 && number % 100 !== 11) {
                return unitForms[time][0]; // forma pojedyncza
            } else if (number % 10 >= 2 && number % 10 <= 4 && (number % 100 < 10 || number % 100 >= 20)) {
                return unitForms[time][1]; // forma dla 2-4
            } else {
                return unitForms[time][2]; // forma dla innych liczb
            }
        }

        function calcTimeAgo(date){
            var timestamp = date.getTime();
            console.log(timestamp);

            var timeNow = new Date().getTime();
            console.log(timeNow);

            var timeDiff = timeNow - timestamp;

            var diffSeconds = Math.floor(timeDiff / 1000);
            var diffMinutes = Math.floor(diffSeconds / 60);
            var diffHours = Math.floor(diffMinutes/ 60);
            var diffDays = Math.floor(diffHours / 24);
            var diffMonths = Math.floor(diffDays / 30);
            var diffYears = Math.floor(diffDays / 356);

            console.log(diffSeconds + " / " + diffMinutes + " / " + diffHours + " / " + diffDays + " / " + diffMonths + " / " + diffYears);

            if (diffSeconds < 60){return `${diffSeconds} ${timeForm("seconds", diffSeconds)} temu`};
            if (diffMinutes < 60){return `${diffMinutes} ${timeForm("minutes", diffMinutes)} temu`};
            if (diffHours < 24){return `${diffHours} ${timeForm("hours", diffHours)} temu`};
            if (diffDays < 30){return `${diffDays} ${timeForm("days", diffDays)} temu`};
            if (diffMonths < 12){return `${diffMonths} ${timeForm("months", diffMonths)} temu`};
            if (diffYears >= 1){
                var calcMonths = diffMonths % 12;
                if (calcMonths === 0){
                    return `${diffYears} ${timeForm("years", diffYears)} temu`;
                }else{
                    return `${diffYears} ${timeForm("years", diffYears)} i ${calcMonths} ${timeForm("months", calcMonths)} temu`;
                }
            };
            

        }

        function hideSup(parrent){
            console.log(parrent);
            var supTags = parrent.querySelectorAll('.sup-delay');
            console.log(supTags);

            supTags.forEach(sup =>{
                sup.style.display = "none";
            });
        }


        function processVData(){
            if (getData != undefined){
                console.log("getData ok");
                dataDsp.innerHTML = "";
                liveDataDsp.innerHTML = "";
                vehiclesMapObject = {};

                getData[1].forEach((vehicle, index) =>{
                    console.log("Pojazd " + vehicles(vehicle.vehicleID));
                    konsola("info", "Pojazd:" + vehicles(vehicle.vehicleID));
                    console.log(vehicle);

                    var run = vehicle.currentRun;

                    console.log(run.driver);

                    var actDriver = drivers(run.driver)


                    if (actDriver != undefined){
                        console.log(actDriver.nick)
                    }else{
                        console.log("Nieznany kierowca");
                    }
                    console.log("");



                    //let startDateTime = run.start ? convertTime(run.start).dateTime : "Nie rozpoczęto kursu";
                    //let endDateTime = run.end ? convertTime(run.end).dateTime : "Kurs nie zakończył się";

                    let runDate = run.start ? convertTime(run.start).date : "";
                    let startTime = run.start ? convertTime(run.start).time : "Nie rozpoczęto kursu";
                    let endTime = run.end ? convertTime(run.end).time : "Kurs nie zakończył się";

                    var dataDspPrepare = "";

                    var dataBlock = document.createElement('div');
                    dataBlock.classList.add('data-block');
                    dataBlock.id = "dBlock" + index;



                    //Początek kursu: ${startDateTime}<br>
                    //Koniec kursu: ${endDateTime}<br>


                    //<div class="vehicle-info">
                            
                    //</div>




                    var vData = modelFinder(vehicles(vehicle.vehicleID));

                    var registerNr = "";
                    if (vData.regNo == "---"){
                        registerNr = "";
                    }else{
                        registerNr = vData.regNo;
                    }

                    dataDspPrepare += `
                        <h2 class="vehicle-h2"><a onclick="showVehInfo('${vData.sideNo}')" id='woz-${vData.sideNo}'>Pojazd ${vData.sideNo}</a></h2>
                        <div class="v-info-container" id="v-info-c-id-${vData.sideNo}">
                            <hr class="v-info-hr"><br>
                            <span class="v-info-model-s" reg-data="${registerNr}"><i class="fas fa-bus-simple v-info-icon"></i>${vData.model}</span>
                            <div class="reg-info" reg-data="${registerNr}">
                                <i class="far fa-id-card v-info-icon"></i>${registerNr}
                            </div>
                        </div><br>

                        Kurs: ${runDate}, ${startTime.slice(0, 5)} - ${endTime.slice(0, 5)}<br>
                    `;
                    console.log(convertTime(run.start).date);
                    console.log(convertTime(run.start).dateTime);
                    console.log(run.start);





                    /*if (isToday(convertTime(run.start).date)){
                        dataDspPrepare += `
                            Dzisiaj<br>
                        `
                    }*/

                    var kiedyCzas = calcTimeAgo(changeTime(convertTime(run.start).dateTime));
                    if (kiedyCzas){
                        var timeTextShow = false;
                        if (isToday(convertTime(run.start).date)){
                            dataDspPrepare += `<span id="timeText-${index}" style="display: none;">Dzisiaj, ${kiedyCzas}<br></span>`
                        }else{
                            dataDspPrepare += `<span id="timeText-${index}" style="display: none;">${kiedyCzas}<br></span>`
                        }
                    }

                    if (vehicle.lastPosition != null){
                        var lp = vehicle.lastPosition;
                    }else{
                        var lp = false;
                    }

                    if (lp && lp.lineNo && lp.lineNo != null && lp.lineNo != " "){
                        var line = lp.lineNo;
                    }else{
                        var line = lines(run.lineID);
                    }
                    if (lp.direction != null && lp){
                        var direction = lp.direction
                    }else{
                        //dodano znaki zapytania
                        var lokacjaKoncowa = run.runStops[run.runStops.length-1]?.locationID
                        if (lokacjaKoncowa){
                            var direction = locations(lokacjaKoncowa);
                        }else{
                            var direction = "";
                        }
                    }

                    dataDspPrepare += `
                        Linia: ${line}<br>
                        Kierunek: ${direction}<br>
                    `;

                    if (lp.latitude && lp.longitude){ // Zmienić linie i direction
                        vehiclesMapObject[lp.taborNo] = [lp.latitude, lp.longitude, lp.lineNo, lp.direction, lp.dateTime, actDriver];
                    }

                    dataDspPrepare += `
                        Brygada: ${run.name}<br><br>
                    `;


                    //dataDspPrepare += "<br>";


                    
                    dataDspPrepare += `<button id="show-stops-bnr-${index}" class="show-stops-btn" onclick="showStops(${index})">Pokaż przystanki</button><br>`;


                    if (/*index == 2*/2+2 == 4){
                        //dataDspPrepare += `${run.runStops[0][]}`;
                        var przystanki = run.runStops;
                        //for (var stop in run.runStops)
                        dataDspPrepare += `
                            <div class="table-wrapper">
                                <table id="s-table-${index}"class='tabela-godziny'>
                                    <tr>
                                        <th>PRZYSTANEK</th>
                                        <th>ROZKŁAD</th>
                                        <th>PRZYJAZD</th>
                                    </tr>
                        `;

                        if (przystanki.length == 0){
                            dataDspPrepare += `
                                <tr>
                                    <td colspan="3" class="brak-stops-warn">BRAK!</td>
                                </tr>
                            `;
                        }else{

                            var przystankiDesc = przystanki.slice();
                            przystankiDesc = przystankiDesc.sort((a, b) => a - b).reverse();

                            for (i=0; i<przystankiDesc.length; i++){
                                var stopLen = przystankiDesc[i];
                                if (stopLen.arrivalTime){
                                    console.log(stopLen);
                                    var aTStop = stopLen;
                                    break;
                                }
                            }

                            run.runStops.forEach((stop, indexStop) =>{
                                var timeLose = "";
                                if (stop.arrivalTime != null){
                                    var czasArrival = convertTime(stop.arrivalTime).time;
                                    //timeLose = "";
                                }else{
                                    var czasArrival = " --- ";
                                    if ((run.runStops.length > indexStop) && (stop.stopOrder && aTStop && aTStop.stopOrder) && (stop.stopOrder > aTStop.stopOrder)){
                                        var spoznienieMin = Math.floor(vehicle.delayMinutes);
                                        if (spoznienieMin < 0){
                                            timeLose = `<sup class="sup-delay">+${Math.abs(spoznienieMin)}</sup>`;
                                        }else if (spoznienieMin > 0){
                                            console.log(spoznienieMin);
                                            timeLose = `<sup class="sup-delay">-${Math.abs(spoznienieMin)}</sup>`;
                                        }else if (spoznienieMin == 0){
                                            timeLose = `<sup class="sup-delay">OK</sup>`;
                                        }
                                        
                                    }else{
                                        //timeLose = "";
                                    }
                                }
                                var stopOrd = stop.stopOrder;
                                if (stopOrd == null){
                                    stopOrd = (run.runStops[indexStop+1].stopOrder);
                                }else if (stopOrd){
                                    stopOrd = stopOrd + 1;
                                }
                                dataDspPrepare += `
                                    <tr style="position: relative;">
                                        <td>${stopOrd}. ${locations(stop.locationID, true)}</td>
                                        <td class="td-center">${convertTime(stop.time).time.slice(0, 5)}${timeLose}</td>
                                        <td class="td-center">${czasArrival}</td>
                                    </tr>`;
                            });
                        }
                        dataDspPrepare += "</table></div>";
                    }




                    //dataDspPrepare += "<br>";





                    if (actDriver != undefined){
                        if (actDriver.ocena != undefined){
                            var gwiazdkiHTML = '';
                            for (var i = 1; i <= 5; i++) {
                                var style = (i <= actDriver.ocena) ? 'fill: orange; stroke: orange;' : 'fill: none; stroke: black;';
                                gwiazdkiHTML += `<span class="ikonaOcena">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="7mm" height="7mm" viewBox="0 0 189.29488 180.95416" version="1.1" style="${style}" class="gwiazdyDriver">
                                        <g id="layer1" transform="translate(-10.352562,-58.022917)">
                                            <path style="stroke-width:10;paint-order:markers fill stroke" id="gwiazda" d="m 66.562734,53.901334 c 0.402143,-1.258656 64.995336,-0.13721 66.060496,-0.91911 1.06516,-0.7819 19.35168,-62.7427105 20.67301,-62.7491957 1.32132,-0.00649 20.21516,61.7718407 21.28794,62.5432477 1.07278,0.771407 65.65186,-0.984022 66.06634,0.270626 0.41448,1.254648 -52.50168,38.314308 -52.90383,39.572963 -0.40214,1.258656 21.2234,62.134555 20.15824,62.916455 -1.06516,0.7819 -52.66298,-38.0923 -53.9843,-38.08581 -1.32132,0.006 -52.53508,39.38528 -53.60787,38.61388 -1.072779,-0.77141 19.95418,-61.856646 19.5397,-63.111294 C 119.43798,91.698448 66.160591,55.15999 66.562734,53.901334 Z" transform="translate(-48.608371,75.289946)"/>
                                        </g>
                                    </svg>
                                </span>`;
                            }
                        }
                        dataDspPrepare += `<h3>Kierowca</h3>`;
                        if (actDriver.nick) dataDspPrepare += `Ksywa: ${actDriver.nick}<br>`;
                        if (actDriver.imie) dataDspPrepare += `Imię: ${actDriver.imie}<br>`;
                        if (actDriver.nazwisko) dataDspPrepare += `Nazwisko: ${actDriver.nazwisko}<br>`;
                        if (gwiazdkiHTML != undefined) dataDspPrepare += `Ocena:<br> ${gwiazdkiHTML}<br><br>`;
                    }else{
                        dataDspPrepare += `<h3>Nieznany kierowca</h3>`;
                        if (run.driver) dataDspPrepare += run.driver + "<br>";
                    }

                    if (run.runStops.length > 0){
                        //Prawdopodobnie sprawdzanie czy dojechał na końcowy, jak nie to gdzie jest
                        console.log("runStops:", run.runStops);
                        console.log("runStops[0]:", run.runStops[0]);
                        console.log("runStops[1]:", run.runStops[1]);
                        console.log("runStops[last]:", run.runStops[run.runStops.length - 1]);


                        //if ((run.runStops[0]?.arrivalTime != null || run.runStops[1]?.arrivalTime != null) && run.runStops[run.runStops.length - 1]?.arrivalTime == null){
                           
                        
                        //if ((run.runStops[0].arrivalTime != null || run.runStops[1].arrivalTime != null) && run.runStops[run.runStops.length-1].arrivalTime == null){
                            



                        //original
                        //if (run.runStops[0].arrivalTime != null && run.runStops[run.runStops.length-1].arrivalTime == null){





                        /*var hasAnyArrival = run.runStops
                            .slice(0, -1) // pomijamy ostatni
                            .some(stop => stop?.arrivalTime != null);

                        if (hasAnyArrival && run.runStops[run.runStops.length-1].arrivalTime == null){*/


                        const lastStop = run.runStops[run.runStops.length - 1];
                        const stopsWithArrival = run.runStops.filter(stop => stop.arrivalTime != null);

                        if (lastStop.arrivalTime == null && (stopsWithArrival.length >= 2 || run.runStops[0].arrivalTime)) {
                            //Tu pętla sprawdzająca kiedy dopiero jest puste arrivalTime
                            console.log("start");
                            var lastPos;

                        
                            /*
                            for (var i = 0; i < run.runStops.length; i++){
                                var tenStop = run.runStops[i];
                                if (tenStop.arrivalTime != null){
                                    console.log(tenStop);
                                    lastPos = tenStop;
                                }else{
                                    console.log("Zatrzymano pętle");
                                    console.log(lastPos);
                                    break;
                                }
                            }
                            */


                            for (var i = run.runStops.length - 1; i >= 0; i--) {
                                var tenStop = run.runStops[i];
                                if (tenStop.arrivalTime != null) {
                                    lastPos = tenStop;
                                    console.log("Znaleziono ostatni z arrivalTime:", lastPos);
                                    break;
                                }
                            }



                            var czasObiekt = changeTime(convertTime(lastPos.arrivalTime).dateTime);
                            console.log(changeTime(convertTime(lastPos.arrivalTime).dateTime));

                            var teraz = new Date();

                            var roznicaCzasu = teraz - czasObiekt;
                            console.log(roznicaCzasu + "  |  " + 60 * 60 * 1000)

                            if (roznicaCzasu <= 60 * 60 * 1000){
                                console.log("Znaleziono")

                                dataDspPrepare += `Ostatnia odnotowana lokalizacja: ${locations(lastPos.locationID)}, ${convertTime(lastPos.arrivalTime).time}<br>`;
                                var spoznienie = vehicle.delaySeconds;
                                var dlMinuty, dlSekundy;

                                if (spoznienie < 0){
                                    spoznienie = Math.abs(spoznienie);
                                    var dlMinuty = Math.floor(spoznienie / 60);
                                    var dlSekundy = spoznienie % 60;
                                    dataDspPrepare += `Aktualne opóźnienie: ${dlMinuty}min ${dlSekundy}s`
                                }else{
                                    dlMinuty = Math.floor(spoznienie / 60);
                                    dlSekundy = spoznienie % 60;
                                    dataDspPrepare += `Kurs przyśpieszony o: ${dlMinuty}min ${dlSekundy}s`
                                }
                                dataBlock.innerHTML = dataDspPrepare;
                                liveDataDsp.appendChild(dataBlock);
                            }else{
                                var lastStopT = run.runStops[run.runStops.length-1].locationID;
                                dataDspPrepare += `Zakończono kurs na ${locations(lastStopT)}`;

                                timeTextShow = true;

                                console.log('buger');
                            }
                        }else{
                            var czasObiekt2 = changeTime(convertTime(run.end).dateTime);
                            console.log(czasObiekt2);

                            var teraz = new Date();
                            console.log(teraz);

                            var roznicaCzasu2 = teraz - czasObiekt2;
                            console.log(roznicaCzasu2 + "  |  " + 60 * 60 * 1000)

                            var lastStopT = run.runStops[run.runStops.length-1].locationID;
                            if (roznicaCzasu2 <= 60 * 60 * 1000){
                                console.log("%cCziluje", "color: red");

                                dataDspPrepare += `<span class="red">Niedawno zakończył kurs na ${locations(lastStopT)}<span>`;

                                dataBlock.innerHTML = dataDspPrepare;
                                liveDataDsp.appendChild(dataBlock);
                            }else{
                                dataDspPrepare += `Zakończono kurs na ${locations(lastStopT)}`;

                                timeTextShow = true;


                                dataBlock.innerHTML = dataDspPrepare;
                                dataDsp.appendChild(dataBlock);
                            }
                        }
                    }else{
                        timeTextShow = true;
                    }
                    if (dataBlock.innerHTML == ''){
                        dataBlock.innerHTML = dataDspPrepare;
                        dataDsp.appendChild(dataBlock);
                    }

                    if (timeTextShow){
                        var ttsElement = document.getElementById(`timeText-${index}`);

                        ttsElement.style.display = "block";
                        hideSup(dataBlock);
                    }


                    console.log('dataDsp:', dataDsp);
                    console.log('dataBlock:', dataBlock);

                    console.log("");
                    console.log("-----------------------------");
                    console.log("");
                });
            }
            
        }

        function showStops(vehicleIndex){
            var tableId = "s-table-"+vehicleIndex;
            var tableEl = document.getElementById(tableId);
            var buttonId = "show-stops-bnr-"+vehicleIndex;
            var buttonEl = document.getElementById(buttonId);

            var tableParent = tableEl.closest('.table-wrapper');

            tableParent.classList.toggle('showTable');
            if (buttonEl.innerHTML == "Pokaż przystanki"){
                buttonEl.innerHTML = "Ukryj przystanki";
            }else{
                buttonEl.innerHTML = "Pokaż przystanki";
            }
        }

        function showVehInfo(vehicleIndex){
            var cInfoId = "v-info-c-id-"+vehicleIndex;
            var cInfoEl = document.getElementById(cInfoId);

            //var tableParent = tableEl.closest('.table-wrapper');

            cInfoEl.classList.toggle('showVInfo');
        }





        var dbJson;

        fetch('../data/database.json')
            .then((response) => response.json())
            .then(json => {
                dbJson = json;
                console.log('Pobrano database.json '+ dbJson.length);
                konsola("info", `<span class="loaded-span"><span>Loaded database.json:   </span>${dbJson.length} vehicles</span>`);

            })
            .catch(error => console.error('Błąd:', error));


        var modelPriority = [
            "SOLARIS  URBINO 18",
            "MERCEDES CONECTO",
            "Konstal 105Na",
            "MAN Lion's City G",
            "SOLARIS URBINO 18 III",
            "MERCEDES CITARO I",
            "MERCEDES CITARO II",
            "MERCEDES CITARO G II",
            "MERCEDES CITARO CNG",
            "MAN Lion's City CNG",
            "MAN NG323 Lion`s City GL",
            "SOLBUS SM18HL Hybryda",
            "SOLBUS SM12HL Hybryda",
            "SOLBUS SM12DC23.05-61",
            "MERCEDES CONECTO III",
            "Autosan M10LFE",
            "Autosan M12LFE",
            "MAN Lion's City A37",
            "SOLARIS URBINO 12 III",
            "SOLARIS URBINO 12 IV",
            "Pesa 129Nb / 2010N",
            "Pesa 2010N-10"

        ]



        var markiKontener = document.getElementById('marki-kontener');
        var dataWozyDsp = document.getElementById('data-wozy-dsp');

        var grupowanieWozow = {};
        var zakladkiWozyNumery = {};

        function loadWozy(){
            if (dbJson != ''){
                grupowanieWozow = {};

                for (let i = 0; i < dbJson.length; i++) {
                    const vehicle = dbJson[i];
                    const model = vehicle.model;

                    if (!grupowanieWozow[model]) {
                        grupowanieWozow[model] = [];
                    }

                    grupowanieWozow[model].push(vehicle);
                }
                console.log(grupowanieWozow);

                markiKontener.innerHTML = '';
                dataWozyDsp.innerHTML = '';
                dataWozyDspCreate = '';

                var indexB = 0;

                var modele = Object.keys(grupowanieWozow);

                // Tworzenie zakładek dla modeli w priorytetowej kolejności
                modelPriority.forEach((model, index) => {
                    if (grupowanieWozow[model]) {
                        var indexModelu = modele.indexOf(model);

                        zakladkiWozyNumery[model] = index;

                        var newZakladka = document.createElement('div');
                        newZakladka.classList.add('new-zakladka');
                        newZakladka.innerHTML = `
                            <button id="btnN${index}" class="zakladka-div" onclick="pokazWozy(${index})">
                                <span class="zakladka-model">${model}</span>
                                <div class="ilosc-wozy-center"><span class="zakladka-ilosc-wozow">Wozy: ${grupowanieWozow[model].length}</span></div>
                            </button>
                        `;
                        markiKontener.appendChild(newZakladka);
                        dataWozyDspCreate += `
                            <div id="WI${index}" class="wozy-zakladka-kontener">
                                <button class="select-button-all" onclick="quickAll('select', ${indexModelu})">[Zaznacz wszystkie]</button>
                                <button class="select-button-all" onclick="quickAll('unselect', ${indexModelu})">[Odznacz wszystkie]</button>
                        `;
                        grupowanieWozow[model].forEach(wozIt =>{
                            dataWozyDspCreate += `
                                <div class="wozy-zakladka-woz-line"><input type="checkbox" class="checkbox-wybor-wozow" id="chbSelect${wozIt.sideNo}" onclick="selectedVehicle('${wozIt.sideNo}', this);"><label for="chbSelect${wozIt.sideNo}">${wozIt.model} #${wozIt.sideNo}</label></div>
                            `;
                        })
                        dataWozyDspCreate += `</div>`;
                        dataWozyDsp.innerHTML = dataWozyDspCreate;
                    }
                    indexB++;
                });
                markiKontener.innerHTML += `<div id="linia-wozy-nieride"><hr class="wozy-nieride-hr">Modele zutylizowane / niejeżdżące liniowo<hr class="wozy-nieride-hr"></div>`;

                // Dodawanie pozostałych modeli, które nie są w priorytetowej kolejności
                for (const model in grupowanieWozow) {
                    if (!modelPriority.includes(model)) {
                        var indexModelu = modele.indexOf(model);

                        zakladkiWozyNumery[model] = indexB;

                        var newZakladka = document.createElement('div');
                        newZakladka.classList.add('new-zakladka');
                        newZakladka.innerHTML = `
                            <button id="btnN${indexB}" class="zakladka-div" onclick="pokazWozy(${indexB})"> 
                                <span class="zakladka-model">${model}</span>
                                <div class="ilosc-wozy-center"><span class="zakladka-ilosc-wozow">Wozy: ${grupowanieWozow[model].length}</span></div>
                            </button>
                        `;
                        markiKontener.appendChild(newZakladka);
                        dataWozyDspCreate += `
                            <div id="WI${indexB}" class="wozy-zakladka-kontener">
                                <button class="select-button-all" onclick="quickAll('select', ${indexModelu})">[Zaznacz wszystkie]</button>
                                <button class="select-button-all" onclick="quickAll('unselect', ${indexModelu})">[Odznacz wszystkie]</button>
                        `;
                        grupowanieWozow[model].forEach(wozIt =>{
                            dataWozyDspCreate += `
                                <div class="wozy-zakladka-woz-line"><input type="checkbox" class="checkbox-wybor-wozow" id="chbSelect${wozIt.sideNo}" onclick="selectedVehicle('${wozIt.sideNo}', this);"><label for="chbSelect${wozIt.sideNo}">${wozIt.model} #${wozIt.sideNo}</label></div>
                            `;
                        })
                        dataWozyDspCreate += `</div>`;
                        dataWozyDsp.innerHTML = dataWozyDspCreate;
                        indexB++;
                    }
                }
            }
        }


        function modelFinder(getNo){
            return dbJson.find(vehicle => vehicle.sideNo == getNo);
        }

        var blackViniette = document.getElementById('black-viniette');
        var alertBox = document.getElementById('alert-box');
        var alertWariant = document.getElementById('alert-wariant');
        var alertTitle = document.getElementById('alert-title');
        var alertContent= document.getElementById('alert-content');

        var warianty = {
            error: {
                icon: "error_icon.svg",
                color: "red"
            },
            warning: {
                icon: "warning_icon.svg",
                color: "orange"
            },
            info: {
                icon: "info_icon.svg",
                color: "#1f69ff"
            },
            success: {
                icon: "success_icon.svg",
                color: "#75FB4C"
            }
        }

        function komunikat(tresc){
            if (tresc != undefined){
                if (typeof tresc === "object"){
                    if (tresc.wariant && tresc.title){
                        if (warianty[tresc.wariant] != undefined){
                            alertWariant.innerHTML = `<img src="images/${warianty[tresc.wariant].icon}">`;
                            alertTitle.style.color = warianty[tresc.wariant].color;
                            
                            alertTitle.innerHTML = tresc.title;
                            alertContent.innerHTML = tresc.content;

                            alertBox.style.display = "block";
                            blackViniette.style.display = "block";
                            setTimeout(() => {
                                alertBox.classList.add('show');
                                blackViniette.classList.add('zakryte');
                            }, 100);
                        }
                    }
                }
            }
        }

        function quickKomunikat(wiadomosc){
            if (wiadomosc != undefined){
                if (wiadomosc == "maxwozy"){
                    komunikat({
                        wariant: "warning",
                        title: "Ostrzeżenie!",
                        content: `Nie możesz zaznaczyć więcej wozów niż ${maxSelectNumber}!`
                    });
                }else{
                    console.log(`%c${tresc}`, "background-color: yellow;");
                }
            }
        }

        /*function komunikat(tresc){ //Stworzenie obiektu lub ogarnięcie tablicy
            if (tresc != undefined){
                if (typeof tresc === "object"){
                    if (warianty[tresc.wariant] != undefined){
                        alertWariant.innerHTML = `<img src="images/${warianty[tresc.wariant].icon}">`;
                        alertTitle.style.color = warianty[tresc.wariant].color;
                    }else{
                        alertWariant.innerHTML = "";  
                    }
                    alertTitle.innerHTML = tresc.title;
                    alertContent.innerHTML = tresc.content;

                    alertBox.style.display = "block";
                }else{
                    if (tresc == "maxwozy"){
                        console.log("%c PRZERWANO SET", "background-color: green;");
                    }else{
                        console.log(`%c${tresc}`, "background-color: yellow;");
                    }
                }
            }
        }*/

        /*function komunikat(tresc){ //Stworzenie obiektu lub ogarnięcie tablicy
            if (tresc != undefined){
                if (typeof tresc === "object"){

                }else{
                    if (tresc == "maxwozy"){
                        console.log("%c PRZERWANO SET", "background-color: green;");
                    }else{
                        console.log(`%c${tresc}`, "background-color: yellow;");
                    }
                }
            }
        }*/

        /*function dispKomunikat(wariant, tytul, tresc){
            if (warianty[wariant] != undefined){
                alertWariant.innerHTML = `<img src="images/${warianty[wariant].icon}">`;
                alertTitle.style.color = warianty[wariant].color;
            }else{
                alertWariant.innerHTML = "";  
            }
            alertTitle.innerHTML = tytul;
            alertContent.innerHTML = tresc;

            alertBox.style.display = "block";
        }*/

        function closeAlertF(){
            if (alertBox.style.display != "none"){
                alertBox.classList.remove('show');
                blackViniette.classList.remove('zakryte');
                setTimeout(() => {
                    alertBox.style.display = 'none';
                    blackViniette.style.display = "none";
                }, 300);
            }
        }




        /*komunikat({
            wariant: "success",
            title: "Ostrzeżenie!",
            content: "Lorem ipsum dolor sit amet consectetur adipisicing elit. Expedita nam explicabo nisi. Corrupti porro dolores tenetur cum ut nam deserunt alias obcaecati recusandae praesentium, iusto fuga consequuntur eum ducimus assumenda?"
        });*/

        var actSelector;

        //SETTING
        var selectDelayTime = 25;
        var maxSelectNumber = 12;


        function quickAll(type, target){
            if (target != undefined && !actSelector){
                var wozNameModel = Object.keys(grupowanieWozow)[target];
                console.log(wozNameModel);

                var tablicaWozy = grupowanieWozow[wozNameModel];
                if (tablicaWozy != undefined){
                    var index2 = 0;
                    var pendingOperations = 0;

                    var stackerVar = stackerGroup[modelFinder(tablicaWozy[0].sideNo).model];

                    if (type == "select"){
                        if (selectedVehiclesTab.length <= maxSelectNumber){
                            var dlugoscStackera = (stackerVar ?? []).length;
                            console.log("------------");
                            console.log(dlugoscStackera);
                            console.log(" < ");
                            console.log(tablicaWozy.length);
                            console.log("------------");


                            var roznica = (tablicaWozy.length - dlugoscStackera) + selectedVehiclesTab.length;
                            console.log(`Różnica: ${roznica} <= ${maxSelectNumber}`);
                            if ((roznica <= maxSelectNumber)){
                                if ((dlugoscStackera < tablicaWozy.length)){
                                    actSelector = true;
                                    tablicaWozy.forEach((e, index) => {
                                        const idCr = "chbSelect" + e.sideNo;
                                        const operationElement = document.getElementById(idCr);
                                        if (!operationElement.checked){
                                            pendingOperations++;
                                            setTimeout(() => {
                                                operationElement.checked = true;
                                                selectedVehicle(e.sideNo, operationElement);
                                                pendingOperations--;

                                                if (pendingOperations === 0) {
                                                    actSelector = false;
                                                    console.log("%c ZAKOŃCZONO", "background-color: red;");
                                                }
                                            }, index2 * selectDelayTime);
                                            index2++;
                                        }
                                    });
                                }
                            }else{
                               quickKomunikat("maxwozy");

                            }
                        }
                        //console.log("%c ZAKOŃCZONO", "background-color: red;");
                    }else if (type == "unselect"){
                        if (stackerVar != undefined){
                            actSelector = true;
                            tablicaWozy.forEach((e, index) => {
                                var idCr = "chbSelect"+e.sideNo;
                                var operationElement = document.getElementById(idCr);
                                if (operationElement.checked){
                                    pendingOperations++;
                                    setTimeout(() => {
                                        operationElement.checked = false;                              
                                        selectedVehicle(e.sideNo, operationElement);
                                        pendingOperations--;

                                        if (pendingOperations === 0) {
                                            actSelector = false;
                                            console.log("%c ZAKOŃCZONO", "background-color: red;");
                                        }
                                    }, index2 * selectDelayTime);
                                    index2++;
                                }else{
                                    console.log("SKIP"); 
                                }
                            });
                        }
                    }

                    //console.log("%c PRZERWANO", "background-color: green;");
    
                }
            }
        }

        /*function pokazWozy(numerZakladki, thisElement){
            console.log(numerZakladki);
            if (numerZakladki != undefined){
                var zakladkaCrId = document.getElementById("WI"+numerZakladki);
                if (zakladkaCrId !== null){
                    const elements = document.querySelectorAll('.wozy-zakladka-kontener');
                    elements.forEach(element => {
                        element.style.display = 'none';
                    });

                    const zakladki = document.querySelectorAll('.zakladka-div');
                    zakladki.forEach(zakladka => {
                        zakladka.style.backgroundColor = '#efefef';
                    });
                    thisElement.style.backgroundColor = "gray";
                    zakladkaCrId.style.display = "inline-block";
                }
            }
        }*/

        function pokazWozy(numerZakladki){
            console.log(numerZakladki);
            if (numerZakladki != undefined){
                var zakladkaCrId = document.getElementById("WI"+numerZakladki);
                var zakladkaButtonEl = document.getElementById("btnN"+numerZakladki);
                var zakladkaWidocznosc = window.getComputedStyle(zakladkaCrId).display;
                if (zakladkaCrId !== null && zakladkaButtonEl){
                    const elements = document.querySelectorAll('.wozy-zakladka-kontener');
                    elements.forEach(element => {
                        element.style.display = 'none';
                    });

                    const zakladki = document.querySelectorAll('.zakladka-div');
                    zakladki.forEach(zakladka => {
                        zakladka.style.backgroundColor = '#efefef';
                    });
                    if (zakladkaWidocznosc == "none"){
                        zakladkaButtonEl.style.backgroundColor = "gray";
                        zakladkaCrId.style.display = "inline-block";
                    }
                }
            }
        }

        var selectedVehiclesTab = [];

        function selectedVehicle(nrThisVeh, thisEl){
            if (selectedVehiclesTab.length <= maxSelectNumber){
                console.log("%c SELECTED VEHICLE", "background-color: blue;");
                //nrThisVeh = parseInt(nrThisVeh);
                console.log(nrThisVeh, thisEl);
                if (nrThisVeh != '' && nrThisVeh != undefined){
                    if (thisEl.checked){
                        console.log('chkd');
                        if (!selectedVehiclesTab.includes(nrThisVeh)){
                            selectedVehiclesTab.push(nrThisVeh);
                        }
                    }else{
                        console.log('nie chkd');
                        if (selectedVehiclesTab.includes(nrThisVeh)){
                            selectedVehiclesTab = selectedVehiclesTab.filter(value => value !== nrThisVeh);
                        }
                    }
                    console.log(selectedVehiclesTab);
                    updateSelectedVeh();
                    maxChecker();
                }
            }
        }

        var disabledAllCheckbox = false;

        function maxChecker(){
            if (selectedVehiclesTab.length >= maxSelectNumber){
                console.log("trueOKOK");
                document.querySelectorAll('.checkbox-wybor-wozow').forEach(checkbox => {
                    if (!checkbox.checked) {
                        checkbox.disabled = true;
                    }
                });
                disabledAllCheckbox = true;
            }else if (disabledAllCheckbox){
                document.querySelectorAll('.checkbox-wybor-wozow').forEach(checkbox => {
                    checkbox.disabled = false;
                });
                console.log("falsowanie" + disabledAllCheckbox);
                disabledAllCheckbox = false;
            }
        }

        //testy czy nie potrzeba maxcheckera w quick

        /*function modelClick(tenModel){
            if (zakladkiWozyNumery[tenModel] != undefined){
                var numerek = zakladkiWozyNumery[tenModel];
                pokazWozy(numerek);
            }
        }*/

        function modelClick(tenModelId){
            if (tenModelId != undefined){
                /*var modelWozu = Object.keys(zakladkiWozyNumery).find(key => zakladkiWozyNumery[key] === tenModelId);
                if (modelWozu != undefined){*/
                    pokazWozy(tenModelId);
                //}
            }
        }


        var wozySelectedKontener = document.getElementById('wozy-selected-kontener');
        var sumaSelectDsp = document.getElementById('suma-select-dsp');
        sumaSelectDsp.innerHTML = `<p id="suma-p"><span id="suma-bold">SUMA: </span>0 / ${maxSelectNumber}</p>`;
        var stackerGroup = {};

        function updateSelectedVeh(){
            if (selectedVehiclesTab != ''){
                selectedVehiclesTab.forEach(savedNo => {
                    vehicleDane = dbJson.find(vehicle => vehicle.sideNo == savedNo);
                    if (!stackerGroup[vehicleDane.model]){
                        stackerGroup[vehicleDane.model] = [];
                    }
                    if (!stackerGroup[vehicleDane.model].includes(savedNo)){
                        stackerGroup[vehicleDane.model].push(savedNo); 
                    }
                })
                for (const model in stackerGroup) {
                    stackerGroup[model] = stackerGroup[model].filter(vehicle => 
                        selectedVehiclesTab.includes(vehicle)
                    );

                    if (stackerGroup[model].length === 0) {
                        delete stackerGroup[model];
                    }
                }
                // Sortowanie numerów w każdej tablicy powiązanej z modelem
                for (const model in stackerGroup) {
                    stackerGroup[model].sort((a, b) => a - b); // sortowanie rosnące
                }

                console.log(stackerGroup);

                var createSelectVeh = "<ul id='lista-selected-wozy'>";
                for (const model in stackerGroup) {
                    const markaGr = stackerGroup[model];
                    var createWoz = "";

                    markaGr.forEach((wozSzt, index) => {
                        createWoz += wozSzt;
                        if (index < markaGr.length - 1){
                            createWoz += ", ";
                        }
                    });

                    var modelIdVar = zakladkiWozyNumery[model];
                    createSelectVeh += `<li><span onclick="modelClick('${modelIdVar}');">${model} (${markaGr.length})</span>:<br> ${createWoz}</li>`;  
                }
                createSelectVeh += `</ul>`;  
                sumaSelectDsp.innerHTML = `<p id="suma-p"><span id="suma-bold">SUMA: </span>${selectedVehiclesTab.length} / ${maxSelectNumber}</p>`;
                wozySelectedKontener.innerHTML = createSelectVeh;      

            }else{
                stackerGroup = {};
                wozySelectedKontener.innerHTML = '';
                sumaSelectDsp.innerHTML = `<p id="suma-p"><span id="suma-bold">SUMA: </span>${selectedVehiclesTab.length} / ${maxSelectNumber}</p>`;
            }
        }

        /*var readyQuery;

        function createQuery(){
            if (qBook.hasOwnProperty(set)){
                var constructQuery = `42/vehicles_exec,["vehicles",[`;
                qBook[set].forEach((taborWoz, index) =>{
                    //dalej kwerenda
                    constructQuery += `"${vehicleId(taborWoz)}"`;
                    if (index < qBook[set].length - 1) {
                        constructQuery += ",";
                    }
                })
                constructQuery += "]]"
                var qTag = constructQuery.length + ":";
                constructQuery = qTag + constructQuery;

                console.log(constructQuery);
                RLoad = constructQuery;
            }
        }*/


        //Funkcja do tworzenia kwerendy z tablicy selectedVehiclesTab lub oneVehicleTab
        function createRequest(type = "full"){
            if (type == "full"){
                var tablica = selectedVehiclesTab;
                var metodaReq = "exec";
            }else if (type == "partOne"){
                var tablica = oneVehicleTab;
                var metodaReq = "gps";
            }
            
            var tablicaLength = tablica.length;
            if (tablicaLength > 0 && tablicaLength <= maxSelectNumber){
                var tablicaSort = tablica.sort((a, b) => a - b);

                var qStart = msgLib[`${metodaReq}BaseStart`];
                var qEnd = msgLib[`${metodaReq}BaseEnd`];

                var queryPayload = qStart;
                tablicaSort.forEach((wozElement, index) =>{
                    queryPayload += `"${vehicleId(wozElement)}"`;
                    if (index < tablicaLength - 1){
                        queryPayload += ",";
                    }

                });
                queryPayload += qEnd;
                queryTag = queryPayload.length + ":";
                queryPayload = queryTag + queryPayload;

                console.log(queryPayload);
                RLoad = queryPayload;
                return "ok";
            }
        }

        //Funkcja do odpytywania o losowym wozie
        function zapTester(){
            var randomIndex = Math.floor(Math.random() * vehiclesJson.length);
            var wylosowany = vehiclesJson[randomIndex];
            console.log("Wylosowano: " + wylosowany.sideNo);

            selectedVehiclesTab = [];
            selectedVehiclesTab.push(wylosowany.sideNo);
            createRequest();
            handshakeSelector(method);
        }

        //
        function gpsTester(){
            komenda("tracking");
            switchMap();
            autoQ("105");
            handshakeSelector("exec");
            setTimeout(() =>{
                loadVehicleMap();
            }, 1000)
        }



        async function test2(){
            await sendRequest(`15:40/vehicle_gps,`);
            await delay(500);
            await sendRequest(``);
            await delay(500);
            await sendRequest(`67:42/vehicle_gps,["vehicleID","e6c0a250-f18e-470f-b1cf-eda724cf1ea3"]`);
            await delay(500);
            await sendRequest(``);
        }

        function test3(){
            loadWozy();
            quickAll('select', 8);
            setTimeout(() =>{
                createRequest();
                handshakeSelector('exec');
            }, 500);
            
        }
    </script>
</body>
</html>
